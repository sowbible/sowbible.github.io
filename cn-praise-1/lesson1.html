<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>1ê³¼. í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì—ìš” Â· ç¥å°±æ˜¯çˆ±</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      background: #f7f9fc;
      font-size: 24px;
      color: #111;
    }
    h1 {
      font-size: 48px;
      margin-bottom: 16px;
      color: #000;
    }

    /* 1~6 ë‹¨ê³„ íƒ­ */
    .step-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }
    .step-tab {
      width: 48px;
      height: 48px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #fed7aa;
      font-size: 24px;
      color: #7c2d12;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .step-tab.active {
      background: #f97316;
      color: #fff;
      box-shadow: 0 0 0 2px #ffedd5 inset;
    }

    /* ëª¨ë“œ íƒ­ */
    .mode-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 12px;
    }
    .mode-tab {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #e0e7ff;
      font-size: 22px;
      color: #111827;
    }
    .mode-tab.active {
      background: #2563eb;
      color: #fff;
    }

    .card {
      background: #ffffff;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    .section-label {
      font-size: 20px;
      color: #374151;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 34px;
      margin-bottom: 10px;
      color: #000;
    }

    /* ì¤‘êµ­ì–´ í…ìŠ¤íŠ¸ */
    .zh {
      font-size: 52px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #b91c1c;
    }

    .pinyin {
      font-size: 30px;
      color: #444;
    }
    .ko {
      font-size: 30px;
      color: #222;
      margin-bottom: 14px;
      white-space: pre-line;
    }
    .hint {
      font-size: 22px;
      color: #555;
      margin-top: 10px;
    }

    button {
      padding: 12px 22px;
      font-size: 24px;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 8px;
      background: #2563eb;
      color: white;
    }
    button.secondary { background: #10b981; }
    button.ghost { background: #e5e7eb; color: #1f2937; }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    /* í”Œë˜ì‹œì¹´ë“œ */
    .flash-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 12px;
    }
    .flashcard {
      min-height: 240px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #ffedd5, #fed7aa); /* ì•ë©´ */
      border-radius: 20px;
      cursor: pointer;
      text-align: center;
      padding: 24px;
      position: relative;
      transition: background 0.25s ease;
    }
    .flashcard.back {
      background: linear-gradient(135deg, #ecfdf5, #a5f3fc); /* ë’·ë©´ */
    }
    .flash-face {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .flash-counter {
      position: absolute;
      top: 10px;
      left: 14px;
      font-size: 18px;
      color: #374151;
      background: rgba(255,255,255,0.8);
      padding: 2px 10px;
      border-radius: 999px;
    }
    .flash-front {
      font-size: 80px;
      font-weight: bold;
      color: #b91c1c;
    }
    .flash-back-main {
      font-size: 44px;
      font-weight: bold;
      color: #000;
      margin-bottom: 6px;
    }
    .flash-back-sub {
      font-size: 30px;
      color: #333;
    }
    .idx-text {
      font-size: 22px;
      margin-top: 10px;
      color: #444;
      text-align: center;
    }
    .arrow-btn {
      width: 48px;
      height: 48px;
      border-radius: 999px;
      border: none;
      background: #e5e7eb;
      font-size: 28px;
      color: #374151;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* ë§ì”€ ì¹´ë“œ */
    .verse-card {
      background: linear-gradient(135deg, #fef3c7, #e0f2fe);
      border-left: 6px solid #f97316;
    }
    .verse-ref {
      font-size: 30px;
      color: #555;
      margin-bottom: 8px;
    }
    .verse-text {
      font-size: 32px;
      white-space: pre-line;
      color: #111;
    }

    /* ìœ íŠœë¸Œ ì˜ìƒ */
    .video-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .video-wrapper iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ì¸ë¼ì¸ í•˜ì´ë¼ì´íŠ¸ (í€´ì¦ˆ/ë¬¸ì¥ ë§Œë“¤ê¸°ìš©) */
    .inline-highlight {
      background: #fed7aa;
      padding: 0 4px;
      border-radius: 6px;
      box-shadow: 0 0 0 2px #fdba74 inset;
    }

    /* ë¯¸ë‹ˆ ë‹¨ì–´ ì¹´ë“œ (ë¬¸ì¥ ë§Œë“¤ê¸°) */
    .mini-card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }
    .mini-card {
      background: #f1f5f9;
      border-radius: 14px;
      padding: 10px 14px;
      min-width: 140px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(15,23,42,0.12);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    .mini-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15,23,42,0.16);
      background: #e0f2fe;
    }
    .mini-card-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #111827;
    }
    .mini-card-zh {
      font-size: 26px;
      color: #b91c1c;
      margin-bottom: 2px;
    }
    .mini-card-sub {
      font-size: 18px;
      color: #4b5563;
    }

    /* 1-6 ë§¤ì¹­ ê²Œì„ ë²„íŠ¼ */
    .match-layout {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .match-col {
      flex: 1;
      min-width: 140px;
    }
    .match-btn {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 8px 14px;
      font-size: 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      text-align: left;
      background: #e5e7eb;
      color: #111827;
      transition: background 0.12s ease, transform 0.12s ease;
    }
    .match-btn:hover {
      background: #d1d5db;
      transform: translateY(-1px);
    }
    .match-btn.selected {
      background: #fee2e2;
    }
    .match-btn.correct {
      background: #bbf7d0;
      cursor: default;
    }
    .match-btn.wrong {
      background: #fecaca;
    }
  </style>
</head>

<body>
  <h1>1ê³¼. í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì—ìš” Â· ç¥å°±æ˜¯çˆ±</h1>

  <div id="step-tabs" class="step-tabs"></div>
  <div id="mode-tabs" class="mode-tabs"></div>
  <div id="content"></div>

  <script>
    /* ===== 1. ë°ì´í„° êµ¬ì„± ===== */

    const globalVerses = [
      { ref: "ìš”í•œì¼ì„œ 4:8~9", textKo: "ì‚¬ë‘í•˜ì§€ ì•„ë‹ˆí•˜ëŠ” ìëŠ” í•˜ë‚˜ë‹˜ì„ ì•Œì§€ ëª»í•˜ë‚˜ë‹ˆ ì´ëŠ” í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì‹¬ì´ë¼ í•˜ë‚˜ë‹˜ì˜ ì‚¬ë‘ì´ ìš°ë¦¬ì—ê²Œ ì´ë ‡ê²Œ ë‚˜íƒ€ë‚œ ë°” ë˜ì—ˆìœ¼ë‹ˆ í•˜ë‚˜ë‹˜ì´ ìê¸°ì˜ ë…ìƒìë¥¼ ì„¸ìƒì— ë³´ë‚´ì‹¬ì€ ê·¸ë¡œ ë§ë¯¸ì•”ì•„ ìš°ë¦¬ë¥¼ ì‚´ë¦¬ë ¤ í•˜ì‹¬ì´ë¼" },
      { ref: "ìš”í•œë³µìŒ 3:16", textKo: "í•˜ë‚˜ë‹˜ì´ ì„¸ìƒì„ ì´ì²˜ëŸ¼ ì‚¬ë‘í•˜ì‚¬ ë…ìƒìë¥¼ ì£¼ì…¨ìœ¼ë‹ˆ ì´ëŠ” ê·¸ë¥¼ ë¯¿ëŠ” ìë§ˆë‹¤ ë©¸ë§í•˜ì§€ ì•Šê³  ì˜ìƒì„ ì–»ê²Œ í•˜ë ¤ í•˜ì‹¬ì´ë¼" },
      { ref: "ìš”í•œì¼ì„œ 4:19", textKo: "ìš°ë¦¬ê°€ ì‚¬ë‘í•¨ì€ ê·¸ê°€ ë¨¼ì € ìš°ë¦¬ë¥¼ ì‚¬ë‘í•˜ì…¨ìŒì´ë¼" }
    ];

    const globalVocab = [
      { hanzi: "ç¥", pinyin: "shÃ©n", koPron: "ì…˜", meaning: "í•˜ë‚˜ë‹˜" },
      { hanzi: "å°±", pinyin: "jiÃ¹", koPron: "ì°Œìš°", meaning: "ë°”ë¡œ" },
      { hanzi: "æ˜¯", pinyin: "shÃ¬", koPron: "ìŠ¤", meaning: "~ì´ë‹¤" },
      { hanzi: "çˆ±", pinyin: "Ã i", koPron: "ì•„ì´", meaning: "ì‚¬ë‘/ì‚¬ë‘í•˜ë‹¤" },
      { hanzi: "æˆ‘", pinyin: "wÇ’", koPron: "ì›Œ", meaning: "ë‚˜" },
      { hanzi: "æˆ‘ä»¬", pinyin: "wÇ’men", koPron: "ì›Œë¨¼", meaning: "ìš°ë¦¬" },
      { hanzi: "ç¥‚", pinyin: "tÄ", koPron: "íƒ€", meaning: "ê·¸(í•˜ë‚˜ë‹˜)" },
      { hanzi: "è¿™æ ·", pinyin: "zhÃ¨yÃ ng", koPron: "ì©Œì–‘", meaning: "ì´ë ‡ê²Œ" },
      { hanzi: "å…‰", pinyin: "guÄng", koPron: "ê½", meaning: "ë¹›" }
    ];

    const songVideoId = "n0_VhV7NFeQ";

    const lesson1 = {
      steps: [
        {
          id: "1-1",
          label: "1-1 ë§ì”€ê³¼ ì°¬ì–‘",
          description: "â€˜ç¥å°±æ˜¯çˆ±(í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì—ìš”)â€™ë¼ëŠ” ê³ ë°±ê³¼ í•¨ê»˜, ë§ì”€ì„ ë¨¼ì € ë§ˆìŒì— ìƒˆê²¨ìš”.",
          sentences: [
            { id: "1-1-1", zh: "ç¥å°±æ˜¯çˆ±ã€‚", pinyin: "shÃ©n jiÃ¹ shÃ¬ Ã i", ko: "í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì„¸ìš”." }
          ],
          verses: globalVerses,
          songVideoId
        },
        {
          id: "1-2",
          label: "1-2 ì°¬ì–‘ ë°°ìš°ê¸°",
          description: "â€˜ç¥å°±æ˜¯çˆ±â€™, â€˜ç¥‚è¿™æ ·çˆ±æˆ‘â€™ë¥¼ ì°¬ì–‘ìœ¼ë¡œ ë°°ìš°ê³ , í•µì‹¬ ë¬¸ì¥ì„ ìµí˜€ìš”.",
          sentences: [
            { id: "1-2-1", zh: "ç¥å°±æ˜¯çˆ±ã€‚", pinyin: "shÃ©n jiÃ¹ shÃ¬ Ã i", ko: "í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì„¸ìš”." },

            { id: "1-2-2", zh: "ç¥‚è¿™æ ·çˆ±æˆ‘ï¼", pinyin: "tÄ zhÃ¨yÃ ng Ã i wÇ’", ko: "í•˜ë‚˜ë‹˜ì€ ì´ë ‡ê²Œ ë‚˜ë¥¼ ì‚¬ë‘í•˜ì„¸ìš”!" }
          ],
          verses: [globalVerses[0]],
          songVideoId
        },
        {
          id: "1-3",
          label: "1-3 í•˜ë‚˜ë‹˜ì€ ëˆ„êµ¬ì‹¤ê¹Œ?",
          description: "'ç¥æ˜¯çˆ±', 'ç¥æ˜¯å…‰'ì„ í†µí•´ í•˜ë‚˜ë‹˜ ì„±í’ˆì„ ë°°ì›Œìš”.",
          sentences: [
            { id: "1-3-1", zh: "ç¥æ˜¯çˆ±ã€‚", pinyin: "shÃ©n shÃ¬ Ã i", ko: "í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì„¸ìš”." },
            { id: "1-3-2", zh: "ç¥æ˜¯å…‰ã€‚", pinyin: "shÃ©n shÃ¬ guÄng", ko: "í•˜ë‚˜ë‹˜ì€ ë¹›ì´ì„¸ìš”." }
          ],
          verses: [
      { ref: "ìš”í•œì¼ì„œ 4:8~9", textKo: "ì‚¬ë‘í•˜ì§€ ì•„ë‹ˆí•˜ëŠ” ìëŠ” í•˜ë‚˜ë‹˜ì„ ì•Œì§€ ëª»í•˜ë‚˜ë‹ˆ ì´ëŠ” í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì‹¬ì´ë¼ í•˜ë‚˜ë‹˜ì˜ ì‚¬ë‘ì´ ìš°ë¦¬ì—ê²Œ ì´ë ‡ê²Œ ë‚˜íƒ€ë‚œ ë°” ë˜ì—ˆìœ¼ë‹ˆ í•˜ë‚˜ë‹˜ì´ ìê¸°ì˜ ë…ìƒìë¥¼ ì„¸ìƒì— ë³´ë‚´ì‹¬ì€ ê·¸ë¡œ ë§ë¯¸ì•”ì•„ ìš°ë¦¬ë¥¼ ì‚´ë¦¬ë ¤ í•˜ì‹¬ì´ë¼" },
      { ref: "ìš”í•œì¼ì„œ 1:5 ä¸­", textKo: "í•˜ë‚˜ë‹˜ì€ ë¹›ì´ì‹œë¼ ê·¸ì—ê²ŒëŠ” ì–´ë‘ ì´ ì¡°ê¸ˆë„ ì—†ìœ¼ì‹œë‹¤ " }
    ],
          songVideoId
        },
        {
          id: "1-4",
          label: "1-4 í•˜ë‚˜ë‹˜ì€ ë‚˜ë¥¼ ì‚¬ë‘í•´",
          description: "â€˜ç¥çˆ±æˆ‘â€™, â€˜ç¥çˆ±æˆ‘ä»¬â€™ë¥¼ ë°°ì›Œìš”.",
          sentences: [
            { id: "1-4-1", zh: "ç¥çˆ±æˆ‘ã€‚", pinyin: "shÃ©n Ã i wÇ’", ko: "í•˜ë‚˜ë‹˜ì€ ë‚˜ë¥¼ ì‚¬ë‘í•˜ì„¸ìš”." },
            { id: "1-4-2", zh: "ç¥çˆ±æˆ‘ä»¬ã€‚", pinyin: "shÃ©n Ã i wÇ’men", ko: "í•˜ë‚˜ë‹˜ì€ ìš°ë¦¬ë¥¼ ì‚¬ë‘í•˜ì„¸ìš”." }
          ],
          verses: [globalVerses[1]],
          songVideoId
        },
        {
          id: "1-5",
          label: "1-5 ë‚˜ëŠ” í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´",
          description: "â€˜æˆ‘çˆ±ç¥â€™, â€˜æˆ‘ä»¬çˆ±ç¥â€™ ê³ ë°±í•´ìš”.",
          sentences: [
            { id: "1-5-1", zh: "æˆ‘çˆ±ç¥ã€‚", pinyin: "wÇ’ Ã i ShÃ©n", ko: "ë‚˜ëŠ” í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´ìš”." },
            { id: "1-5-2", zh: "æˆ‘ä»¬çˆ±ç¥ã€‚", pinyin: "wÇ’men Ã i ShÃ©n", ko: "ìš°ë¦¬ëŠ” í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´ìš”." }
          ],
          verses: [globalVerses[2]],
          songVideoId
        },
        {
          id: "1-6",
          label: "1-6 ì°¬ì–‘ ë³µìŠµ",
          description: "1ê³¼ ì „ì²´ ë¬¸ì¥ì„ ë³µìŠµí•´ìš”.",
          sentences: [
            { id: "1-6-1", zh: "ç¥å°±æ˜¯çˆ±ã€‚", pinyin: "shÃ©n jiÃ¹ shÃ¬ Ã i", ko: "í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì„¸ìš”." },
            { id: "1-6-2", zh: "ç¥çˆ±æˆ‘ã€‚", pinyin: "shÃ©n Ã i wÇ’", ko: "í•˜ë‚˜ë‹˜ì€ ë‚˜ë¥¼ ì‚¬ë‘í•˜ì„¸ìš”." },
            { id: "1-6-3", zh: "æˆ‘çˆ±ç¥ã€‚", pinyin: "wÇ’ Ã i ShÃ©n", ko: "ë‚˜ëŠ” í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´ìš”." }
          ],
          verses: globalVerses,
          songVideoId
        }
      ]
    };

    /* ëª¨ë“œ ì •ì˜ (ë¼ë²¨ ê·¸ëŒ€ë¡œ ìœ ì§€) */
    const modesBase = [
      { id: "study", label: "í•™ìŠµ ë¬¸ì¥" },
      { id: "flash", label: "í”Œë˜ì‹œ ì¹´ë“œ" },
      { id: "quiz", label: "í€´ì¦ˆ" },
      { id: "verse", label: "ë§ì”€ ì¹´ë“œ" },
      { id: "song", label: "ì°¬ì–‘ ë°°ìš°ê¸°" }
    ];

    let currentStepId = "1-1";
    let currentModeId = "study";

    const recordings = {};

    /* === ìƒˆë¡œ ì¶”ê°€ëœ í•µì‹¬ í•¨ìˆ˜: ê° íƒ­ë§ˆë‹¤ ì“¸ ìˆ˜ ìˆëŠ” ëª¨ë“œ ì œí•œ === */
    function getStepModes(step) {
      if (!step) return ["study"];

      // íƒ­ 1: ë§ì”€ ì¹´ë“œë§Œ
      if (step.id === "1-1") {
        return ["verse"];
      }
      // íƒ­ 2: ì°¬ì–‘ ë™ì˜ìƒ + í•™ìŠµ ë¬¸ì¥ + í”Œë˜ì‹œ ì¹´ë“œ
      if (step.id === "1-2") {
        return ["song", "study", "flash"];
      }
      // íƒ­ 3~6: ê¸°ì¡´ì²˜ëŸ¼ (í•™ìŠµ, í”Œë˜ì‹œ, í€´ì¦ˆ, ë§ì”€)
      return ["study", "flash", "quiz", "verse"];
    }

    /* ===== ê³µí†µ í•¨ìˆ˜ ===== */

    function getCurrentStep() {
      return lesson1.steps.find(s => s.id === currentStepId);
    }
    function clear(el) {
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    function speakChineseOnce(text) {
      if (!("speechSynthesis" in window)) {
        alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
        return;
      }
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-CN";
      u.rate = 0.65;
      speechSynthesis.speak(u);
    }

    function speakChineseRepeated(text) {
      if (!("speechSynthesis" in window)) {
        alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
        return;
      }
      speechSynthesis.cancel();
      let count = 0;
      function play() {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "zh-CN";
        u.rate = 0.65;
        u.onend = () => {
          count++;
          if (count < 5) setTimeout(play, 300);
        };
        speechSynthesis.speak(u);
      }
      play();
    }

    async function recordSentence(id, statusEl) {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
        return;
      }
      statusEl.textContent = "ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”. (ë¸Œë¼ìš°ì € ìƒë‹¨ í™•ì¸)";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const rec = new MediaRecorder(stream);
        const chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          recordings[id] = URL.createObjectURL(blob);
          statusEl.textContent = "ë…¹ìŒ ì™„ë£Œ! 'ë…¹ìŒ ë“£ê¸° â–¶'ë¥¼ ëˆŒëŸ¬ ë³´ì„¸ìš”.";
          stream.getTracks().forEach(t => t.stop());
        };
        rec.start();
        statusEl.textContent = "ë…¹ìŒ ì¤‘... ë”°ë¼ ë§í•´ ë³´ì„¸ìš”.";
        setTimeout(() => { if (rec.state !== "inactive") rec.stop(); }, 6000);
      } catch (e) {
        statusEl.textContent = "ë§ˆì´í¬ ê¶Œí•œì´ ê±°ì ˆë˜ì—ˆì–´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
      }
    }

    function playRecording(id) {
      if (!recordings[id]) {
        alert("ì•„ì§ ë…¹ìŒì´ ì—†ì–´ìš”.");
        return;
      }
      new Audio(recordings[id]).play();
    }

    /* ===== 2. ë¬¸ì¥ ë§Œë“¤ê¸°ìš© ë‹¨ì–´ ì„¸íŠ¸ ===== */

    const wordMaps = {
      "1-3": {
        templateKo: "í•˜ë‚˜ë‹˜ì€ (      ) ì´ì„¸ìš”.",
        templateZhPrefix: "ç¥æ˜¯",
        templateZhSuffix: "ã€‚",
        words: {
          "ì‚¬ë‘":  { zh: "çˆ±",   pinyin: "Ã i",          meaning: "ì‚¬ë‘" },
          "ë¹›":    { zh: "å…‰",   pinyin: "guÄng",       meaning: "ë¹›" },
          "ì°½ì¡°ì£¼": { zh: "åˆ›é€ ä¸»", pinyin: "chuÃ ngzÃ ozhÇ”", meaning: "ì°½ì¡°ì£¼" },
          "ì£¼ì¸":  { zh: "ä¸»",   pinyin: "zhÇ”",         meaning: "ì£¼ì¸" },
        }
      },
      "1-4": {
        templateKo: "í•˜ë‚˜ë‹˜ì€ (      )ë¥¼(ì„) ì‚¬ë‘í•˜ì„¸ìš”.",
        templateZhPrefix: "ç¥çˆ±",
        templateZhSuffix: "ã€‚",
        words: {
          "ë‚˜":     { zh: "æˆ‘",     pinyin: "wÇ’",      meaning: "ë‚˜" },
          "ìš°ë¦¬":   { zh: "æˆ‘ä»¬",   pinyin: "wÇ’men",   meaning: "ìš°ë¦¬" },
          "ì—„ë§ˆ":   { zh: "å¦ˆå¦ˆ",   pinyin: "mÄma",    meaning: "ì—„ë§ˆ" },
          "ì•„ë¹ ":   { zh: "çˆ¸çˆ¸",   pinyin: "bÃ ba",    meaning: "ì•„ë¹ " },
          "ì¹œêµ¬":   { zh: "æœ‹å‹",   pinyin: "pÃ©ngyou", meaning: "ì¹œêµ¬" },
          "í˜•":     { zh: "å“¥å“¥",   pinyin: "gÄ“ge",    meaning: "í˜•" },
          "ëˆ„ë‚˜":   { zh: "å§å§",   pinyin: "jiÄ›jie",  meaning: "ëˆ„ë‚˜/ì–¸ë‹ˆ" },
          "ë‚¨ë™ìƒ": { zh: "å¼Ÿå¼Ÿ",   pinyin: "dÃ¬di",    meaning: "ë‚¨ë™ìƒ" },
          "ì—¬ë™ìƒ": { zh: "å¦¹å¦¹",   pinyin: "mÃ¨imei",  meaning: "ì—¬ë™ìƒ" },
          "í• ì•„ë²„ì§€": { zh: "çˆ·çˆ·", pinyin: "yÃ©ye",   meaning: "í• ì•„ë²„ì§€" },
          "í• ë¨¸ë‹ˆ": { zh: "å¥¶å¥¶",   pinyin: "nÇinai",  meaning: "í• ë¨¸ë‹ˆ" }
        }
      },
      "1-5": {
        templateKo: "(      )ëŠ”(ì€) í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´ìš”.",
        templateZhPrefix: "",
        templateZhSuffix: "çˆ±ç¥ã€‚",
        words: {
          "ë‚˜":     { zh: "æˆ‘",     pinyin: "wÇ’",      meaning: "ë‚˜" },
          "ìš°ë¦¬":   { zh: "æˆ‘ä»¬",   pinyin: "wÇ’men",   meaning: "ìš°ë¦¬" },
          "ì—„ë§ˆ":   { zh: "å¦ˆå¦ˆ",   pinyin: "mÄma",    meaning: "ì—„ë§ˆ" },
          "ì•„ë¹ ":   { zh: "çˆ¸çˆ¸",   pinyin: "bÃ ba",    meaning: "ì•„ë¹ " },
          "ì¹œêµ¬":   { zh: "æœ‹å‹",   pinyin: "pÃ©ngyou", meaning: "ì¹œêµ¬" },
          "í˜•":     { zh: "å“¥å“¥",   pinyin: "gÄ“ge",    meaning: "í˜•" },
          "ëˆ„ë‚˜":   { zh: "å§å§",   pinyin: "jiÄ›jie",  meaning: "ëˆ„ë‚˜/ì–¸ë‹ˆ" },
          "ë‚¨ë™ìƒ": { zh: "å¼Ÿå¼Ÿ",   pinyin: "dÃ¬di",    meaning: "ë‚¨ë™ìƒ" },
          "ì—¬ë™ìƒ": { zh: "å¦¹å¦¹",   pinyin: "mÃ¨imei",  meaning: "ì—¬ë™ìƒ" },
          "í• ì•„ë²„ì§€": { zh: "çˆ·çˆ·", pinyin: "yÃ©ye",   meaning: "í• ì•„ë²„ì§€" },
          "í• ë¨¸ë‹ˆ": { zh: "å¥¶å¥¶",   pinyin: "nÇinai",  meaning: "í• ë¨¸ë‹ˆ" }
        }
      }
    };

    /* ===== 3. ëª¨ë“œë³„ ë Œë”ë§ ===== */

    function renderStudy(step, c) {
      const intro = document.createElement("div");
      intro.className = "card";
      intro.innerHTML = `
        <div class="section-label">${step.label} Â· í•™ìŠµ ë¬¸ì¥</div>
        <div class="ko">${step.description || ""}</div>
      `;
      c.appendChild(intro);

      if (step.sentences && step.sentences.length) {
        step.sentences.forEach((s, i) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="section-label">í•™ìŠµ ë¬¸ì¥ ${i + 1}</div>
            <div class="zh">${s.zh}</div>
            <div class="pinyin">${s.pinyin}</div>
            <div class="ko">${s.ko}</div>
            <div class="btn-row">
              <button id="once-${s.id}">í•œë²ˆ ë“£ê¸° â–¶</button>
              <button id="five-${s.id}" class="secondary">ë‹¤ì„¯ ë²ˆ ë“£ê¸° â–¶â–¶</button>
              <button class="secondary" id="rec-${s.id}">ë…¹ìŒí•˜ê¸° ğŸ¤</button>
              <button class="ghost" id="play-${s.id}">ë…¹ìŒ ë“£ê¸° â–¶</button>
            </div>
            <div class="hint" id="status-${s.id}">ë¬¸ì¥ì„ ë“£ê³  5ë²ˆ ë”°ë¼ ë§í•´ ë³´ì„¸ìš”.</div>
          `;
          c.appendChild(card);

          document.getElementById(`once-${s.id}`).onclick = () => speakChineseOnce(s.zh);
          document.getElementById(`five-${s.id}`).onclick = () => speakChineseRepeated(s.zh);
          document.getElementById(`rec-${s.id}`).onclick = () => {
            recordSentence(s.id, document.getElementById(`status-${s.id}`));
          };
          document.getElementById(`play-${s.id}`).onclick = () => {
            playRecording(s.id);
          };
        });
      }
    }

    function renderFlash(step, c) {
      const intro = document.createElement("div");
      intro.className = "card";
      intro.innerHTML = `
        <div class="section-label">${step.label} Â· í”Œë˜ì‹œ ì¹´ë“œ</div>
        <div class="ko">í•œìë¥¼ ì•ë©´, ëœ»ê³¼ ë³‘ìŒì„ ë’·ë©´ì—ì„œ ë³´ë©° ë“£ê³ , ë…¹ìŒí•´ ë³´ì•„ìš”.</div>
      `;
      c.appendChild(intro);

      let stepVocab = globalVocab.filter(v =>
        step.sentences && step.sentences.some(s => s.zh.includes(v.hanzi))
      );
      if (stepVocab.length === 0) stepVocab = globalVocab;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="flash-wrapper">
          <button class="arrow-btn" id="flash-prev">â—€</button>
          <div class="flashcard" id="flash-card">
            <div class="flash-counter" id="flash-counter"></div>
            <div class="flash-face" id="flash-face"></div>
          </div>
          <button class="arrow-btn" id="flash-next">â–¶</button>
        </div>
        <div class="idx-text" id="flash-idx"></div>
        <div class="btn-row">
          <button id="flash-speak">ë‹¤ì‹œ ë“£ê¸° â–¶</button>
          <button class="secondary" id="flash-rec">ë…¹ìŒí•˜ê¸° ğŸ¤</button>
          <button class="ghost" id="flash-play">ë…¹ìŒ ë“£ê¸° â–¶</button>
        </div>
        <div class="hint" id="flash-status">ì¹´ë“œë¥¼ ëˆŒëŸ¬ ì•/ë’·ë©´ì„ ë°”ê¿” ë³´ì„¸ìš”.</div>
      `;
      c.appendChild(card);

      let idx = 0;
      let front = true;

      function draw() {
        const v = stepVocab[idx];
        const face = document.getElementById("flash-face");
        const counterEl = document.getElementById("flash-counter");
        const cardEl = document.getElementById("flash-card");

        counterEl.textContent = `${idx + 1} / ${stepVocab.length}`;
        document.getElementById("flash-idx").innerText = `${idx + 1} / ${stepVocab.length}`;

        if (front) {
          cardEl.classList.remove("back");
          face.innerHTML = `<div class="flash-front">${v.hanzi}</div>`;
          speakChineseOnce(v.hanzi);
        } else {
          cardEl.classList.add("back");
          face.innerHTML = `
            <div class="flash-back-main">${v.meaning}</div>
            <div class="flash-back-sub">${v.hanzi} Â· ${v.pinyin}</div>
          `;
        }
      }

      document.getElementById("flash-card").onclick = () => {
        front = !front;
        draw();
      };
      document.getElementById("flash-prev").onclick = () => {
        idx = (idx - 1 + stepVocab.length) % stepVocab.length;
        front = true;
        draw();
      };
      document.getElementById("flash-next").onclick = () => {
        idx = (idx + 1) % stepVocab.length;
        front = true;
        draw();
      };
      document.getElementById("flash-speak").onclick = () => {
        const v = stepVocab[idx];
        speakChineseOnce(v.hanzi);
      };
      document.getElementById("flash-rec").onclick = () => {
        const v = stepVocab[idx];
        recordSentence("flash-" + step.id + "-" + v.hanzi, document.getElementById("flash-status"));
      };
      document.getElementById("flash-play").onclick = () => {
        const v = stepVocab[idx];
        playRecording("flash-" + step.id + "-" + v.hanzi);
      };

      draw();
    }

    function renderQuiz(step, c) {
      const intro = document.createElement("div");
      intro.className = "card";

      /* === ë¨¼ì €: 1-3, 1-4, 1-5 ë¬¸ì¥ ë§Œë“¤ê¸° (ë§¨ ìœ„) === */
      const mapForStep = wordMaps[step.id];
      if (mapForStep) {
        const openCard = document.createElement("div");
        openCard.className = "card";
        let zhTemplateInit = "";
        let koTemplateInit = "";

        if (step.id === "1-3") {
          zhTemplateInit = `ç¥æ˜¯<span class="inline-highlight">ï¼ˆ      ï¼‰</span>ã€‚`;
          koTemplateInit = `í•˜ë‚˜ë‹˜ì€ <span class="inline-highlight">(      )</span>ì´ì„¸ìš”.`;
        } else if (step.id === "1-4") {
          zhTemplateInit = `ç¥çˆ±<span class="inline-highlight">ï¼ˆ      ï¼‰</span>ã€‚`;
          koTemplateInit = `í•˜ë‚˜ë‹˜ì€ <span class="inline-highlight">(      )</span>ë¥¼(ì„) ì‚¬ë‘í•˜ì„¸ìš”.`;
        } else if (step.id === "1-5") {
          zhTemplateInit = `<span class="inline-highlight">ï¼ˆ      ï¼‰</span>çˆ±ç¥ã€‚`;
          koTemplateInit = `<span class="inline-highlight">(      )</span>ëŠ”(ì€) í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´ìš”.`;
        }

        openCard.innerHTML = `
          <div class="section-label">${step.label} Â· ë¬¸ì¥ ë§Œë“¤ê¸°</div>
          <div style="background:#e0f2fe; padding:12px 16px; border-radius:12px;">
            <div id="tmpl-zh-${step.id}" class="zh" style="font-size:40px; margin-bottom:6px;">
              ${zhTemplateInit}
            </div>
            <div id="tmpl-ko-${step.id}" class="ko" style="margin:0;">
              ${koTemplateInit}
            </div>
          </div>
          <div class="hint" style="margin-top:4px;">
            ì•„ë˜ <b>ë‹¨ì–´ ì¹´ë“œ</b>ë¥¼ ëˆŒëŸ¬ì„œ ê´„í˜¸ ì•ˆ ë‹¨ì–´ë¥¼ ê³¨ë¼ ë³´ì„¸ìš”. ì„ íƒí•˜ë©´ ìœ„ ë¬¸ì¥ì— ë“¤ì–´ê°€ê³  ì¤‘êµ­ì–´ ë¬¸ì¥ì„ í•œ ë²ˆ ì½ì–´ì¤˜ìš”.
          </div>
          <div class="mini-card-container" id="mini-wrap-${step.id}"></div>
          <div class="zh" id="open-zh-${step.id}" style="display:none; margin-top:16px;"></div>
          <div class="pinyin" id="open-py-${step.id}" style="display:none;"></div>
          <div class="ko" id="open-ko-${step.id}" style="display:none; font-size:24px;"></div>
          <div class="hint" id="open-status-${step.id}"></div>
        `;
        c.appendChild(openCard);

        const wrap = document.getElementById(`mini-wrap-${step.id}`);
        const zhEl = document.getElementById(`open-zh-${step.id}`);
        const pyEl = document.getElementById(`open-py-${step.id}`);
        const koEl = document.getElementById(`open-ko-${step.id}`);
        const statusEl = document.getElementById(`open-status-${step.id}`);
        const tmplZhEl = document.getElementById(`tmpl-zh-${step.id}`);
        const tmplKoEl = document.getElementById(`tmpl-ko-${step.id}`);

        Object.entries(mapForStep.words).forEach(([kr, info]) => {
          const mc = document.createElement("div");
          mc.className = "mini-card";
          mc.innerHTML = `
            <div class="mini-card-title">${kr}</div>
            <div class="mini-card-zh">${info.zh}</div>
            <div class="mini-card-sub">${info.pinyin} Â· ${info.meaning}</div>
          `;
          mc.onclick = () => {
            let zhSentence = "";
            if (step.id === "1-5") {
              zhSentence = info.zh + mapForStep.templateZhSuffix;
              tmplZhEl.innerHTML = `<span class="inline-highlight">${info.zh}</span>çˆ±ç¥ã€‚`;
              tmplKoEl.innerHTML = `<span class="inline-highlight">${kr}</span>ëŠ”(ì€) í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´ìš”.`;
            } else if (step.id === "1-4") {
              zhSentence = mapForStep.templateZhPrefix + info.zh + mapForStep.templateZhSuffix;
              tmplZhEl.innerHTML = `ç¥çˆ±<span class="inline-highlight">${info.zh}</span>ã€‚`;
              tmplKoEl.innerHTML = `í•˜ë‚˜ë‹˜ì€ <span class="inline-highlight">${kr}</span>ë¥¼(ì„) ì‚¬ë‘í•˜ì„¸ìš”.`;
            } else if (step.id === "1-3") {
              zhSentence = mapForStep.templateZhPrefix + info.zh + mapForStep.templateZhSuffix;
              tmplZhEl.innerHTML = `ç¥æ˜¯<span class="inline-highlight">${info.zh}</span>ã€‚`;
              tmplKoEl.innerHTML = `í•˜ë‚˜ë‹˜ì€ <span class="inline-highlight">${kr}</span>ì´ì„¸ìš”.`;
            }

            zhEl.style.display = "block";
            pyEl.style.display = "block";
            koEl.style.display = "block";

            zhEl.textContent = zhSentence;
            pyEl.textContent = info.pinyin;
            koEl.textContent = `"${kr}"(ë¥¼(ì„)) ë„£ì–´ì„œ ë§Œë“  ë¬¸ì¥ì´ì—ìš”.`;
            statusEl.textContent = "ì™„ì„±ëœ ì¤‘êµ­ì–´ ë¬¸ì¥ì„ í•œ ë²ˆ ì½ì–´ ì¤„ê²Œìš”.";

            speakChineseOnce(zhSentence);
          };
          wrap.appendChild(mc);
        });
      }

      /* === ê¸°ë³¸ í€´ì¦ˆ ë¬¸í•­ (ë¬¸ì¥ ë§Œë“¤ê¸° ì•„ë˜ì— ìœ„ì¹˜) === */
      if (step.sentences && step.sentences.length) {
        step.sentences.forEach((s, i) => {
          let koHtml = "Q. " + s.ko;

          if (step.id === "1-3") {
            if (s.ko.includes("ì‚¬ë‘ì´ì„¸ìš”")) {
              koHtml = 'Q. í•˜ë‚˜ë‹˜ì€ <span class="inline-highlight">ì‚¬ë‘</span>ì´ì„¸ìš”.';
            } else if (s.ko.includes("ë¹›ì´ì„¸ìš”")) {
              koHtml = 'Q. í•˜ë‚˜ë‹˜ì€ <span class="inline-highlight">ë¹›</span>ì´ì„¸ìš”.';
            }
          } else if (step.id === "1-4") {
            if (s.ko.includes("ë‚˜ë¥¼")) {
              koHtml = 'Q. í•˜ë‚˜ë‹˜ì€ <span class="inline-highlight">ë‚˜ë¥¼</span> ì‚¬ë‘í•˜ì„¸ìš”.';
            } else if (s.ko.includes("ìš°ë¦¬ë¥¼")) {
              koHtml = 'Q. í•˜ë‚˜ë‹˜ì€ <span class="inline-highlight">ìš°ë¦¬ë¥¼</span> ì‚¬ë‘í•˜ì„¸ìš”.';
            }
          } else if (step.id === "1-5") {
            if (s.ko.includes("ë‚˜ëŠ”")) {
              koHtml = 'Q. <span class="inline-highlight">ë‚˜ëŠ”</span> í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´ìš”.';
            } else if (s.ko.includes("ìš°ë¦¬ëŠ”")) {
              koHtml = 'Q. <span class="inline-highlight">ìš°ë¦¬ëŠ”</span> í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•´ìš”.';
            }
          }

          const q = document.createElement("div");
          q.className = "card";
          q.style.marginTop = "12px";
          q.innerHTML = `
            <div class="section-label">í€´ì¦ˆ ${i + 1}</div>
            <div class="ko">${koHtml}</div>
            <div class="btn-row">
              <button class="secondary" id="quiz-rec-${s.id}">ì¤‘êµ­ì–´ë¡œ ë§í•˜ê¸° ğŸ¤</button>
              <button class="ghost" id="quiz-play-${s.id}">ë…¹ìŒ ë“£ê¸° â–¶</button>
              <button id="quiz-answer-${s.id}">ì •ë‹µ ë“£ê¸° â–¶</button>
            </div>
            <div class="zh" id="quiz-zh-${s.id}" style="display:none; margin-top:10px;"></div>
            <div class="hint" id="quiz-status-${s.id}"></div>
          `;
          c.appendChild(q);

          document.getElementById(`quiz-rec-${s.id}`).onclick = () => {
            recordSentence("quiz-" + s.id, document.getElementById(`quiz-status-${s.id}`));
          };
          document.getElementById(`quiz-play-${s.id}`).onclick = () => {
            playRecording("quiz-" + s.id);
          };
          document.getElementById(`quiz-answer-${s.id}`).onclick = () => {
            speakChineseOnce(s.zh);
            const zhEl = document.getElementById(`quiz-zh-${s.id}`);
            zhEl.style.display = "block";
            zhEl.textContent = `${s.zh} (${s.pinyin})`;
          };
        });
      }

      /* === 1-6: ë‹¨ì–´ Â· ëœ» ë§¤ì¹­ ê²Œì„ (í´ë¦­) === */
      if (step.id === "1-6") {
        const matchCard = document.createElement("div");
        matchCard.className = "card";
        matchCard.innerHTML = `
          <div class="section-label">1-6 Â· ë‹¨ì–´ Â· ëœ» ë§ì¶”ê¸° ê²Œì„</div>
          <div class="ko">
            ì™¼ìª½ í•œìì™€ ì˜¤ë¥¸ìª½ ëœ»ì„ <b>ìˆœì„œëŒ€ë¡œ ëˆŒëŸ¬ì„œ</b> ì§ì„ ë§ì¶° ë³´ì„¸ìš”.<br>
            ì •ë‹µì´ë©´ ìƒ‰ì´ ì´ˆë¡ìœ¼ë¡œ ë³€í•˜ê³ , ì¤‘êµ­ì–´ ë°œìŒì„ ë“¤ì„ ìˆ˜ ìˆì–´ìš”.
          </div>

          <div class="match-layout">
            <div class="match-col" id="match-left"></div>
            <div class="match-col" id="match-right"></div>
          </div>

          <div class="hint" id="match-status" style="margin-top:12px;"></div>
        `;
        c.appendChild(matchCard);

        const leftEl = document.getElementById("match-left");
        const rightEl = document.getElementById("match-right");
        const statusEl = document.getElementById("match-status");

        const leftItems = [
          { key: "ç¥", label: "â‘  ç¥" },
          { key: "çˆ±", label: "â‘¡ çˆ±" },
          { key: "æˆ‘", label: "â‘¢ æˆ‘" },
          { key: "æˆ‘ä»¬", label: "â‘£ æˆ‘ä»¬" },
          { key: "å…‰", label: "â‘¤ å…‰" }
        ];
        const rightItems = [
          { key: "çˆ±", label: "A. ì‚¬ë‘/ì‚¬ë‘í•˜ë‹¤" },
          { key: "æˆ‘", label: "B. ë‚˜" },
          { key: "æˆ‘ä»¬", label: "C. ìš°ë¦¬" },
          { key: "ç¥", label: "D. í•˜ë‚˜ë‹˜" },
          { key: "å…‰", label: "E. ë¹›" }
        ];

        let selectedLeft = null;
        let completedPairs = 0;
        const totalPairs = leftItems.length;

        leftItems.forEach(item => {
          const btn = document.createElement("button");
          btn.className = "match-btn";
          btn.textContent = item.label;
          btn.dataset.key = item.key;
          btn.onclick = () => {
            if (btn.classList.contains("correct")) return;
            document.querySelectorAll("#match-left .match-btn").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            selectedLeft = item.key;
            statusEl.textContent = "ì´ì œ ì˜¤ë¥¸ìª½ì—ì„œ ëœ»ì„ ê³¨ë¼ ë³´ì„¸ìš”.";
          };
          leftEl.appendChild(btn);
        });

        rightItems.forEach(item => {
          const btn = document.createElement("button");
          btn.className = "match-btn";
          btn.textContent = item.label;
          btn.dataset.key = item.key;
          btn.onclick = () => {
            if (btn.classList.contains("correct")) return;
            const leftSelectedBtn = document.querySelector("#match-left .match-btn.selected");
            if (!leftSelectedBtn) {
              statusEl.textContent = "ë¨¼ì € ì™¼ìª½ í•œìë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.";
              return;
            }
            const leftKey = leftSelectedBtn.dataset.key;
            const rightKey = item.key;

            if (leftKey === rightKey) {
              leftSelectedBtn.classList.remove("selected");
              leftSelectedBtn.classList.add("correct");
              btn.classList.add("correct");
              completedPairs++;
              statusEl.textContent = "ì •ë‹µì´ì—ìš”! ì˜í–ˆì–´ìš” ğŸ‘";

              speakChineseOnce(leftKey);

              if (completedPairs === totalPairs) {
                statusEl.textContent = "ëª¨ë“  ë‹¨ì–´ë¥¼ ë‹¤ ë§ì·„ì–´ìš”! ë©‹ì ¸ìš” ğŸ‰";
              }
            } else {
              btn.classList.add("wrong");
              statusEl.textContent = "ì•„ì‰½ì§€ë§Œ ë‹¤ì‹œ~ í•œ ë²ˆ ë” ìƒê°í•´ ë³´ì!";
              setTimeout(() => {
                btn.classList.remove("wrong");
                if (leftSelectedBtn) leftSelectedBtn.classList.remove("selected");
              }, 600);
            }

            selectedLeft = null;
          };
          rightEl.appendChild(btn);
        });
      }
    }

    function renderVerse(step, c) {
      const intro = document.createElement("div");
      intro.className = "card";
      intro.innerHTML = `
        <div class="section-label">${step.label} Â· ë§ì”€ ì¹´ë“œ</div>
        <div class="ko">${step.description || ""}</div>
      `;
      c.appendChild(intro);

      (step.verses || []).forEach(v => {
        const card = document.createElement("div");
        card.className = "card verse-card";
        card.innerHTML = `
          <div class="verse-ref">ğŸ“– ${v.ref}</div>
          <div class="verse-text">${v.textKo}</div>
        `;
        c.appendChild(card);
      });
    }

    function renderSong(step, c) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="section-label">${step.label} Â· ì°¬ì–‘ ì˜ìƒ</div>
        <h2>ì¤‘êµ­ì–´ ì°¬ì–‘ - ç¥å°±æ˜¯çˆ±</h2>
        <div class="video-wrapper">
          <iframe
            src="https://www.youtube.com/embed/${step.songVideoId || songVideoId}"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen>
          </iframe>
        </div>
        <div class="hint">ì˜ìƒê³¼ í•¨ê»˜ ê°€ì‚¬ë¥¼ ë³´ë©° ë”°ë¼ ë¶ˆëŸ¬ìš”.</div>
      `;
      c.appendChild(card);

      if (step.sentences && step.sentences.length) {
        const lyric = document.createElement("div");
        lyric.className = "card";
        lyric.innerHTML = `<div class="section-label">í•µì‹¬ ê°€ì‚¬ & í‘œí˜„</div>`;
        step.sentences.forEach(s => {
          const block = document.createElement("div");
          block.style.marginBottom = "16px";
          block.innerHTML = `
            <div class="zh">${s.zh}</div>
            <div class="pinyin">${s.pinyin}</div>
            <div class="ko">${s.ko}</div>
            <div class="btn-row">
              <button>í•œë²ˆ ë“£ê¸° â–¶</button>
              <button>ë‹¤ì„¯ ë²ˆ ë“£ê¸° â–¶â–¶</button>
            </div>
          `;
          const [btnOnce, btnFive] = block.querySelectorAll("button");
          btnOnce.onclick = () => speakChineseOnce(s.zh);
          btnFive.onclick = () => speakChineseRepeated(s.zh);
          lyric.appendChild(block);
        });
        c.appendChild(lyric);
      }
    }

    /* ===== 4. ì „ì²´ ë Œë” ===== */

    const stepTabsEl = document.getElementById("step-tabs");
    const modeTabsEl = document.getElementById("mode-tabs");
    const contentEl = document.getElementById("content");

    function renderStepTabs() {
      clear(stepTabsEl);
      lesson1.steps.forEach((step, idx) => {
        const b = document.createElement("button");
        b.className = "step-tab";
        if (step.id === currentStepId) b.classList.add("active");
        b.textContent = (idx + 1).toString();
        b.onclick = () => {
          currentStepId = step.id;
          const allowed = getStepModes(step);
          if (!allowed.includes(currentModeId)) {
            currentModeId = allowed[0];
          }
          renderStepTabs();
          renderModeTabs();
          renderContent();
        };
        stepTabsEl.appendChild(b);
      });
    }

    function renderModeTabs() {
      clear(modeTabsEl);
      const step = getCurrentStep();
      if (!step) return;

      const enabledIds = getStepModes(step);
      enabledIds.forEach(id => {
        const m = modesBase.find(mm => mm.id === id);
        if (!m) return;
        const b = document.createElement("button");
        b.className = "mode-tab";
        if (m.id === currentModeId) b.classList.add("active");
        b.textContent = m.label;
        b.onclick = () => {
          currentModeId = m.id;
          renderModeTabs();
          renderContent();
        };
        modeTabsEl.appendChild(b);
      });
    }

    function renderContent() {
      clear(contentEl);
      const step = getCurrentStep();
      if (!step) return;

      const enabled = getStepModes(step);
      if (!enabled.includes(currentModeId)) {
        currentModeId = enabled[0];
        renderModeTabs();
      }

      if (currentModeId === "study") renderStudy(step, contentEl);
      else if (currentModeId === "flash") renderFlash(step, contentEl);
      else if (currentModeId === "quiz") renderQuiz(step, contentEl);
      else if (currentModeId === "verse") renderVerse(step, contentEl);
      else if (currentModeId === "song") renderSong(step, contentEl);
    }

    renderStepTabs();
    renderModeTabs();
    renderContent();
  </script>
</body>
</html>

