<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>2ê³¼. ë‚˜ëŠ” ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì°¬ì–‘í•  ê±°ì˜ˆìš” Â· æˆ‘è¦æ­Œé¢‚æˆ‘ç¥</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      background: #f7f9fc;
      font-size: 24px;
      color: #111;
    }
    h1 {
      font-size: 42px;
      margin-bottom: 4px;
      color: #000;
    }
    .sub-title {
      font-size: 22px;
      color: #4b5563;
      margin-bottom: 16px;
    }

    /* ìƒë‹¨ ë ˆì´ì•„ì›ƒ: íƒ­(ì™¼ìª½) + ì´ë¯¸ì§€(ì˜¤ë¥¸ìª½) */
    .top-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    .top-left {
      flex: 1;
    }
    .top-right {
      width: 220px;
      flex-shrink: 0;
    }

    /* 2ê³¼ ì´ë¯¸ì§€ ì¹´ë“œ (ê¹”ë”, ê°ì„±) */
    .lesson2-image-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 10px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lesson2-image {
      display: block;
      width: 100%;
      height: auto;
      border-radius: 16px;
      object-fit: cover;
    }

    /* ë‹¨ê³„ íƒ­ */
    .step-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }
    .step-tab {
      min-width: 52px;
      height: 52px;
      padding: 0 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #fed7aa;
      font-size: 22px;
      color: #7c2d12;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .step-tab.active {
      background: #f97316;
      color: #fff;
      box-shadow: 0 0 0 2px #ffedd5 inset;
    }

    /* ëª¨ë“œ íƒ­ */
    .mode-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 0;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 12px;
    }
    .mode-tab {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #e0e7ff;
      font-size: 20px;
      color: #111827;
    }
    .mode-tab.active {
      background: #2563eb;
      color: #fff;
    }

    .card {
      background: #ffffff;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    .section-label {
      font-size: 18px;
      color: #374151;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 30px;
      margin-bottom: 10px;
      color: #000;
    }

    .zh {
      font-size: 44px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #b91c1c;
    }
    .pinyin {
      font-size: 26px;
      color: #444;
    }
    .ko {
      font-size: 24px;
      color: #222;
      margin-bottom: 14px;
      white-space: pre-line;
    }
    .hint {
      font-size: 20px;
      color: #555;
      margin-top: 10px;
    }

    button {
      padding: 10px 18px;
      font-size: 20px;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 8px;
      background: #2563eb;
      color: white;
    }
    button.secondary { background: #10b981; }
    button.ghost { background: #e5e7eb; color: #1f2937; }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    /* ìœ íŠœë¸Œ ì˜ìƒ */
    .video-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .video-wrapper iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ë§ì”€ ì¹´ë“œ */
    .verse-card {
      background: linear-gradient(135deg, #fef3c7, #e0f2fe);
      border-left: 6px solid #f97316;
    }
    .verse-ref {
      font-size: 24px;
      color: #555;
      margin-bottom: 8px;
    }
    .verse-text {
      font-size: 26px;
      white-space: pre-line;
      color: #111;
    }

    .inline-highlight {
      background: #fed7aa;
      padding: 0 4px;
      border-radius: 6px;
      box-shadow: 0 0 0 2px #fdba74 inset;
    }

    .mini-card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }
    .mini-card {
      background: #f1f5f9;
      border-radius: 14px;
      padding: 10px 14px;
      min-width: 150px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(15,23,42,0.12);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    .mini-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15,23,42,0.16);
      background: #e0f2fe;
    }
    .mini-card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #111827;
    }
    .mini-card-zh {
      font-size: 24px;
      color: #b91c1c;
      margin-bottom: 2px;
    }
    .mini-card-sub {
      font-size: 16px;
      color: #4b5563;
    }

    .match-layout {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .match-col {
      flex: 1;
      min-width: 180px;
    }
    .match-btn {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 8px 14px;
      font-size: 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      text-align: left;
      background: #e5e7eb;
      color: #111827;
      transition: background 0.12s ease, transform 0.12s ease;
    }
    .match-btn:hover {
      background: #d1d5db;
      transform: translateY(-1px);
    }
    .match-btn.selected {
      background: #fee2e2;
    }
    .match-btn.correct {
      background: #bbf7d0;
      cursor: default;
    }
    .match-btn.wrong {
      background: #fecaca;
    }

    /* í”Œë˜ì‹œ ì¹´ë“œ ê³µí†µ */
    .flash-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 12px;
    }
    .flashcard {
      min-height: 220px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #ffedd5, #fed7aa);
      border-radius: 20px;
      cursor: pointer;
      text-align: center;
      padding: 24px;
      position: relative;
      transition: background 0.25s ease;
    }
    .flashcard.back {
      background: linear-gradient(135deg, #ecfdf5, #a5f3fc);
    }
    .flash-face {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .flash-counter {
      position: absolute;
      top: 10px;
      left: 14px;
      font-size: 18px;
      color: #374151;
      background: rgba(255,255,255,0.8);
      padding: 2px 10px;
      border-radius: 999px;
    }
    .flash-front {
      font-size: 72px;
      font-weight: bold;
      color: #b91c1c;
    }
    .flash-back-main {
      font-size: 38px;
      font-weight: bold;
      color: #000;
      margin-bottom: 6px;
    }
    .flash-back-sub {
      font-size: 24px;
      color: #333;
    }
    .idx-text {
      font-size: 20px;
      margin-top: 10px;
      color: #444;
      text-align: center;
    }
    .arrow-btn {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: none;
      background: #e5e7eb;
      font-size: 26px;
      color: #374151;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* í•™ìŠµë¬¸ì¥ ì „ìš© í”Œë˜ì‹œì¹´ë“œëŠ” ì•½ê°„ ë” ì½¤íŒ©íŠ¸í•˜ê²Œ */
    .study-flash-card .flashcard {
      min-height: 200px;
    }
    .study-flash-card .flash-front {
      font-size: 60px;
    }
    .study-flash-card .flash-back-main {
      font-size: 32px;
    }
    .study-flash-card .flash-back-sub {
      font-size: 22px;
    }
  </style>
</head>
<body>
  <h1 id="lesson-title"></h1>
  <div id="lesson-subtitle" class="sub-title"></div>

  <div class="top-layout">
    <div class="top-left">
      <div id="step-tabs" class="step-tabs"></div>
      <div id="mode-tabs" class="mode-tabs"></div>
    </div>
    <div class="top-right">
      <div class="lesson2-image-card">
        <!-- ê°™ì€ í´ë”ì— lesson2-side.png ë„£ê¸° -->
        <img src="lesson2-side.png" alt="2ê³¼ í‘œì§€" class="lesson2-image" />
      </div>
    </div>
  </div>

  <div id="content"></div>

  <script>
    /* ========= 2ê³¼ ë°ì´í„° ========= */
    const lesson = {
      id: "lesson2",
      title: "2ê³¼. ë‚˜ëŠ” ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì°¬ì–‘í•  ê±°ì˜ˆìš” Â· æˆ‘è¦æ­Œé¢‚æˆ‘ç¥",
      subtitle: "ì°¬ì–‘ìœ¼ë¡œ ë°°ìš°ëŠ” ì¤‘êµ­ì–´ Â· æˆ‘è¦æ­Œé¢‚æˆ‘ç¥",
      songUrl: "https://www.youtube.com/embed/rFqW2FPWiVw",
      steps: [
        {
          id: "2-1",
          tabLabel: "1",
          label: "2-1 ë§ì”€ & ì°¬ì–‘",
          description:
            "â€˜æˆ‘è¦æ­Œé¢‚æˆ‘ç¥â€™ì„ ê³ ë°±í•˜ë©°, ì°¬ì–‘ê³¼ ì‚¬ë‘ê³¼ ê°ì‚¬ì˜ ë§ì”€ì„ ë¨¼ì € ë§ˆìŒì— ìƒˆê²¨ìš”.",
          modes: ["verse", "study", "song", "flash"],
          sentences: [
            {
              id: "2-1-1",
              zh: "æˆ‘è¦æ­Œé¢‚æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o gÄ“sÃ²ng wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì°¬ì–‘í•  ê±°ì˜ˆìš”."
            }
          ],
          verses: [
            {
              ref: "ì‹œí¸ 150:6",
              textKo: "í˜¸í¡ì´ ìˆëŠ” ìë§ˆë‹¤ ì—¬í˜¸ì™€ë¥¼ ì°¬ì–‘í• ì§€ì–´ë‹¤ í• ë ë£¨ì•¼!"
            },
            {
              ref: "ì‹ ëª…ê¸° 6:5",
              textKo: "ë„ˆëŠ” ë§ˆìŒì„ ë‹¤í•˜ê³  ëœ»ì„ ë‹¤í•˜ê³  í˜ì„ ë‹¤í•˜ì—¬ ë„¤ í•˜ë‚˜ë‹˜ ì—¬í˜¸ì™€ë¥¼ ì‚¬ë‘í•˜ë¼."
            },
            {
              ref: "ì‹œí¸ 136:1",
              textKo: "ì—¬í˜¸ì™€ê»˜ ê°ì‚¬í•˜ë¼ ê·¸ëŠ” ì„ í•˜ì‹œë©° ê·¸ ì¸ìí•˜ì‹¬ì´ ì˜ì›í•¨ì´ë¡œë‹¤."
            }
          ]
        },
        {
          id: "2-2",
          tabLabel: "2",
          label: "2-2 ì°¬ì–‘ ë°°ìš°ê¸°",
          description:
            "ì°¬ì–‘ì˜ ì„¸ ê°€ì§€ ê³ ë°± â€˜ì°¬ì–‘í•´ìš”Â·ì‚¬ë‘í•´ìš”Â·ê°ì‚¬í•´ìš”â€™ë¥¼ ì¤‘êµ­ì–´ë¡œ ë°°ì›Œìš”.",
          modes: ["song", "study", "flash", "verse"],
          sentences: [
            {
              id: "2-2-1",
              zh: "æˆ‘è¦æ­Œé¢‚æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o gÄ“sÃ²ng wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì°¬ì–‘í•  ê±°ì˜ˆìš”."
            },
            {
              id: "2-2-2",
              zh: "æˆ‘è¦çˆ±ä½ æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o Ã i nÇ wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‹¹ì‹ , ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•  ê±°ì˜ˆìš”."
            },
            {
              id: "2-2-3",
              zh: "æˆ‘è¦æ„Ÿè°¢æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o gÇnxiÃ¨ wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‚˜ì˜ í•˜ë‚˜ë‹˜ê»˜ ê°ì‚¬í•  ê±°ì˜ˆìš”."
            }
          ],
          verses: [
            {
              ref: "ì‹œí¸ 150:6",
              textKo: "í˜¸í¡ì´ ìˆëŠ” ìë§ˆë‹¤ ì—¬í˜¸ì™€ë¥¼ ì°¬ì–‘í• ì§€ì–´ë‹¤ í• ë ë£¨ì•¼!"
            },
            {
              ref: "ì‹ ëª…ê¸° 6:5",
              textKo: "ë„ˆëŠ” ë§ˆìŒì„ ë‹¤í•˜ê³  ëœ»ì„ ë‹¤í•˜ê³  í˜ì„ ë‹¤í•˜ì—¬ ë„¤ í•˜ë‚˜ë‹˜ ì—¬í˜¸ì™€ë¥¼ ì‚¬ë‘í•˜ë¼."
            },
            {
              ref: "ì‹œí¸ 136:1",
              textKo: "ì—¬í˜¸ì™€ê»˜ ê°ì‚¬í•˜ë¼ ê·¸ëŠ” ì„ í•˜ì‹œë©° ê·¸ ì¸ìí•˜ì‹¬ì´ ì˜ì›í•¨ì´ë¡œë‹¤."
            }
          ]
        },
        {
          id: "2-3",
          tabLabel: "3",
          label: "2-3 ë‚˜ëŠ” ì°¬ì–‘í•  ê±°ì˜ˆìš”",
          description:
            "â€˜æˆ‘è¦æ­Œé¢‚~â€™ íŒ¨í„´ìœ¼ë¡œ í•˜ë‚˜ë‹˜ê³¼ ì˜ˆìˆ˜ë‹˜ì„ ì°¬ì–‘í•˜ëŠ” ë¬¸ì¥ì„ ë§Œë“¤ì–´ ë´ìš”.",
          modes: ["study", "builder", "flash", "verse"],
          sentences: [
            {
              id: "2-3-1",
              zh: "æˆ‘è¦æ­Œé¢‚æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o gÄ“sÃ²ng wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì°¬ì–‘í•  ê±°ì˜ˆìš”."
            }
          ],
          builderBlocks: [
            {
              id: "praise",
              title: "ë‚˜ëŠ” ì°¬ì–‘í•  ê±°ì˜ˆìš” Â· ë¬¸ì¥ ë§Œë“¤ê¸°",
              templateZhDisplay: "æˆ‘è¦æ­Œé¢‚<span class=\"inline-highlight\">{{zh}}</span>ã€‚",
              templateKoDisplay:
                "ë‚˜ëŠ” <span class=\"inline-highlight\">{{ko}}</span>ì„/ë¥¼ ì°¬ì–‘í•  ê±°ì˜ˆìš”.",
              templateZhSpeak: "æˆ‘è¦æ­Œé¢‚{{zh}}ã€‚",
              explainKoPrefix:
                "â€˜{{ko}}â€™(ì„/ë¥¼) ë„£ì–´ì„œ ë§Œë“  í•˜ë‚˜ë‹˜ê»˜ ë“œë¦¬ëŠ” ì°¬ì–‘ ê³ ë°±ì´ì—ìš”.",
              cards: [
                { zh: "æˆ‘ç¥",   pinyin: "wÇ’ shÃ©n",       ko: "ë‚˜ì˜ í•˜ë‚˜ë‹˜",     meaning: "ë‚˜ì˜ í•˜ë‚˜ë‹˜" },
                { zh: "ç¥",    pinyin: "shÃ©n",          ko: "í•˜ë‚˜ë‹˜",           meaning: "í•˜ë‚˜ë‹˜" },
                { zh: "ä¸Šå¸",  pinyin: "ShÃ ngdÃ¬",       ko: "í•˜ë‚˜ë‹˜(ìƒì œë‹˜)",   meaning: "í•˜ë‚˜ë‹˜(ìƒì œë‹˜)" },
                { zh: "è€¶ç¨£",  pinyin: "YÄ“sÅ«",          ko: "ì˜ˆìˆ˜ë‹˜",           meaning: "ì˜ˆìˆ˜ë‹˜" },
                { zh: "ä¸»",    pinyin: "ZhÇ”",           ko: "ì£¼ë‹˜",             meaning: "ì£¼ë‹˜" },
                { zh: "åˆ›é€ ä¸»", pinyin: "chuÃ ngzÃ o zhÇ”", ko: "ì°½ì¡°ì£¼ í•˜ë‚˜ë‹˜",   meaning: "ì°½ì¡°ì£¼ í•˜ë‚˜ë‹˜" },
                { zh: "å¤©çˆ¶",  pinyin: "TiÄnfÃ¹",        ko: "í•˜ëŠ˜ ì•„ë²„ì§€",     meaning: "í•˜ëŠ˜ ì•„ë²„ì§€" }
              ]
            }
          ],
          verses: [
            {
              ref: "ì‹œí¸ 150:6",
              textKo: "í˜¸í¡ì´ ìˆëŠ” ìë§ˆë‹¤ ì—¬í˜¸ì™€ë¥¼ ì°¬ì–‘í• ì§€ì–´ë‹¤ í• ë ë£¨ì•¼!"
            },
            {
              ref: "ì‹œí¸ 147:1",
              textKo: "í• ë ë£¨ì•¼ ìš°ë¦¬ í•˜ë‚˜ë‹˜ì„ ì°¬ì–‘í•˜ëŠ” ì¼ì´ ì„ í•¨ì´ì—¬ ì°¬ì†¡í•˜ëŠ” ì¼ì´ ì•„ë¦„ë‹µê³  ë§ˆë•…í•˜ë„ë‹¤."
            }
          ]
        },
        {
          id: "2-4",
          tabLabel: "4",
          label: "2-4 ë‚˜ëŠ” ì‚¬ë‘í•  ê±°ì˜ˆìš”",
          description:
            "â€˜æˆ‘è¦çˆ±~â€™ íŒ¨í„´ìœ¼ë¡œ í•˜ë‚˜ë‹˜ê³¼ ê°€ì¡±, ì¹œêµ¬ë“¤ì„ ì‚¬ë‘í•˜ëŠ” ë§ˆìŒì„ ê³ ë°±í•´ìš”.",
          modes: ["study", "builder", "flash", "verse"],
          sentences: [
            {
              id: "2-4-1",
              zh: "æˆ‘è¦çˆ±ä½ æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o Ã i nÇ wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‹¹ì‹ , ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•  ê±°ì˜ˆìš”."
            }
          ],
          builderBlocks: [
            {
              id: "love",
              title: "ë‚˜ëŠ” ì‚¬ë‘í•  ê±°ì˜ˆìš” Â· ë¬¸ì¥ ë§Œë“¤ê¸°",
              templateZhDisplay: "æˆ‘è¦çˆ±<span class=\"inline-highlight\">{{zh}}</span>ã€‚",
              templateKoDisplay:
                "ë‚˜ëŠ” <span class=\"inline-highlight\">{{ko}}</span>ì„/ë¥¼ ì‚¬ë‘í•  ê±°ì˜ˆìš”.",
              templateZhSpeak: "æˆ‘è¦çˆ±{{zh}}ã€‚",
              explainKoPrefix: "â€˜{{ko}}â€™(ì„/ë¥¼) ë„£ì–´ì„œ ë§Œë“  ì‚¬ë‘ ê³ ë°±ì´ì—ìš”.",
              cards: [
                { zh: "ç¥",    pinyin: "shÃ©n",      ko: "í•˜ë‚˜ë‹˜",       meaning: "í•˜ë‚˜ë‹˜" },
                { zh: "è€¶ç¨£",  pinyin: "YÄ“sÅ«",      ko: "ì˜ˆìˆ˜ë‹˜",       meaning: "ì˜ˆìˆ˜ë‹˜" },
                { zh: "æˆ‘",    pinyin: "wÇ’",        ko: "ë‚˜",           meaning: "ë‚˜" },
                { zh: "ä½ ",    pinyin: "nÇ",        ko: "ë„ˆ",           meaning: "ë„ˆ" },
                { zh: "ä»–",    pinyin: "tÄ",        ko: "ê·¸",           meaning: "ê·¸" },
                { zh: "å¥¹",    pinyin: "tÄ",        ko: "ê·¸ë…€",         meaning: "ê·¸ë…€" },
                { zh: "æˆ‘ä»¬",  pinyin: "wÇ’men",     ko: "ìš°ë¦¬",         meaning: "ìš°ë¦¬" },
                { zh: "ä½ ä»¬",  pinyin: "nÇmen",     ko: "ë„ˆí¬",         meaning: "ë„ˆí¬" },
                { zh: "ä»–ä»¬",  pinyin: "tÄmen",     ko: "ê·¸ë“¤",         meaning: "ê·¸ë“¤" },
                { zh: "å¦ˆå¦ˆ",  pinyin: "mÄma",      ko: "ì—„ë§ˆ",         meaning: "ì—„ë§ˆ" },
                { zh: "çˆ¸çˆ¸",  pinyin: "bÃ ba",      ko: "ì•„ë¹ ",         meaning: "ì•„ë¹ " },
                { zh: "å“¥å“¥",  pinyin: "gÄ“ge",      ko: "í˜•",           meaning: "í˜•" },
                { zh: "å§å§",  pinyin: "jiÄ›jie",    ko: "ëˆ„ë‚˜/ì–¸ë‹ˆ",    meaning: "ëˆ„ë‚˜/ì–¸ë‹ˆ" },
                { zh: "å¼Ÿå¼Ÿ",  pinyin: "dÃ¬di",      ko: "ë‚¨ë™ìƒ",       meaning: "ë‚¨ë™ìƒ" },
                { zh: "å¦¹å¦¹",  pinyin: "mÃ¨imei",    ko: "ì—¬ë™ìƒ",       meaning: "ì—¬ë™ìƒ" }
              ]
            }
          ],
          verses: [
            {
              ref: "ì‹ ëª…ê¸° 6:5",
              textKo: "ë„ˆëŠ” ë§ˆìŒì„ ë‹¤í•˜ê³  ëœ»ì„ ë‹¤í•˜ê³  í˜ì„ ë‹¤í•˜ì—¬ ë„¤ í•˜ë‚˜ë‹˜ ì—¬í˜¸ì™€ë¥¼ ì‚¬ë‘í•˜ë¼."
            },
            {
              ref: "ë§ˆíƒœë³µìŒ 22:37",
              textKo: "ì˜ˆìˆ˜ê»˜ì„œ ì´ë¥´ì‹œë˜ ë„¤ ë§ˆìŒì„ ë‹¤í•˜ê³  ëª©ìˆ¨ì„ ë‹¤í•˜ê³  ëœ»ì„ ë‹¤í•˜ì—¬ ì£¼ ë„ˆì˜ í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•˜ë¼ í•˜ì…¨ìœ¼ë‹ˆ."
            }
          ]
        },
        {
          id: "2-5",
          tabLabel: "5",
          label: "2-5 ë‚˜ëŠ” ê³ ë§ˆì›Œìš”",
          description:
            "â€˜è°¢è°¢~â€™ íŒ¨í„´ìœ¼ë¡œ í•˜ë‚˜ë‹˜ê³¼ ê°€ì¡±, ì£¼ë³€ ì‚¬ëŒë“¤ì—ê²Œ ê°ì‚¬ ì¸ì‚¬ë¥¼ ì—°ìŠµí•´ìš”.",
          modes: ["study", "builder", "flash", "verse"],
          sentences: [
            {
              id: "2-5-1",
              zh: "è°¢è°¢ç¥ï¼",
              pinyin: "xiÃ¨xie shÃ©n!",
              ko: "í•˜ë‚˜ë‹˜, ê³ ë§ˆì›Œìš”!"
            }
          ],
          builderBlocks: [
            {
              id: "thanks",
              title: "ê³ ë§ˆì›Œìš” Â· ë¬¸ì¥ ë§Œë“¤ê¸°",
              templateZhDisplay: "è°¢è°¢<span class=\"inline-highlight\">{{zh}}</span>ï¼",
              templateKoDisplay:
                "<span class=\"inline-highlight\">{{ko}}</span>ì—ê²Œ ê³ ë§ˆì›Œìš”.",
              templateZhSpeak: "è°¢è°¢{{zh}}ï¼",
              explainKoPrefix: "â€˜{{ko}}â€™ì—ê²Œ ê³ ë§ˆìš´ ë§ˆìŒì„ ì „í•´ìš”.",
              cards: [
                { zh: "ç¥",    pinyin: "shÃ©n",      ko: "í•˜ë‚˜ë‹˜",       meaning: "í•˜ë‚˜ë‹˜" },
                { zh: "è€¶ç¨£",  pinyin: "YÄ“sÅ«",      ko: "ì˜ˆìˆ˜ë‹˜",       meaning: "ì˜ˆìˆ˜ë‹˜" },
                { zh: "æˆ‘",    pinyin: "wÇ’",        ko: "ë‚˜",           meaning: "ë‚˜" },
                { zh: "ä½ ",    pinyin: "nÇ",        ko: "ë„ˆ",           meaning: "ë„ˆ" },
                { zh: "ä»–",    pinyin: "tÄ",        ko: "ê·¸",           meaning: "ê·¸" },
                { zh: "å¥¹",    pinyin: "tÄ",        ko: "ê·¸ë…€",         meaning: "ê·¸ë…€" },
                { zh: "æˆ‘ä»¬",  pinyin: "wÇ’men",     ko: "ìš°ë¦¬",         meaning: "ìš°ë¦¬" },
                { zh: "ä½ ä»¬",  pinyin: "nÇmen",     ko: "ë„ˆí¬",         meaning: "ë„ˆí¬" },
                { zh: "ä»–ä»¬",  pinyin: "tÄmen",     ko: "ê·¸ë“¤",         meaning: "ê·¸ë“¤" },
                { zh: "å¦ˆå¦ˆ",  pinyin: "mÄma",      ko: "ì—„ë§ˆ",         meaning: "ì—„ë§ˆ" },
                { zh: "çˆ¸çˆ¸",  pinyin: "bÃ ba",      ko: "ì•„ë¹ ",         meaning: "ì•„ë¹ " },
                { zh: "å“¥å“¥",  pinyin: "gÄ“ge",      ko: "í˜•",           meaning: "í˜•" },
                { zh: "å§å§",  pinyin: "jiÄ›jie",    ko: "ëˆ„ë‚˜/ì–¸ë‹ˆ",    meaning: "ëˆ„ë‚˜/ì–¸ë‹ˆ" },
                { zh: "å¼Ÿå¼Ÿ",  pinyin: "dÃ¬di",      ko: "ë‚¨ë™ìƒ",       meaning: "ë‚¨ë™ìƒ" },
                { zh: "å¦¹å¦¹",  pinyin: "mÃ¨imei",    ko: "ì—¬ë™ìƒ",       meaning: "ì—¬ë™ìƒ" }
              ]
            }
          ],
          verses: [
            {
              ref: "ì‹œí¸ 136:1",
              textKo: "ì—¬í˜¸ì™€ê»˜ ê°ì‚¬í•˜ë¼ ê·¸ëŠ” ì„ í•˜ì‹œë©° ê·¸ ì¸ìí•˜ì‹¬ì´ ì˜ì›í•¨ì´ë¡œë‹¤."
            },
            {
              ref: "ê³¨ë¡œìƒˆì„œ 3:17",
              textKo: "ë˜ ë¬´ì—‡ì„ í•˜ë“ ì§€ ë§ì—ë‚˜ ì¼ì—ë‚˜ ë‹¤ ì£¼ ì˜ˆìˆ˜ì˜ ì´ë¦„ìœ¼ë¡œ í•˜ê³  ê·¸ë¥¼ í˜ì…ì–´ í•˜ë‚˜ë‹˜ ì•„ë²„ì§€ê»˜ ê°ì‚¬í•˜ë¼."
            }
          ]
        },
        {
          id: "2-6",
          tabLabel: "6",
          label: "2-6 ë‚˜ëŠ” ë¯¸ì•ˆí•´ìš”",
          description:
            "â€˜å¯¹ä¸èµ·~â€™ íŒ¨í„´ìœ¼ë¡œ í•˜ë‚˜ë‹˜ê³¼ ì‚¬ëŒë“¤ ì•ì—ì„œ ë¯¸ì•ˆí•œ ë§ˆìŒì„ í‘œí˜„í•´ìš”.",
          modes: ["study", "builder", "flash", "verse"],
          sentences: [
            {
              id: "2-6-1",
              zh: "å¯¹ä¸èµ·ç¥ï¼",
              pinyin: "duÃ¬buqÇ shÃ©n!",
              ko: "í•˜ë‚˜ë‹˜, ë¯¸ì•ˆí•´ìš”."
            }
          ],
          builderBlocks: [
            {
              id: "sorry",
              title: "ë¯¸ì•ˆí•´ìš” Â· ë¬¸ì¥ ë§Œë“¤ê¸°",
              templateZhDisplay: "å¯¹ä¸èµ·<span class=\"inline-highlight\">{{zh}}</span>ï¼",
              templateKoDisplay:
                "<span class=\"inline-highlight\">{{ko}}</span>ì—ê²Œ ë¯¸ì•ˆí•´ìš”.",
              templateZhSpeak: "å¯¹ä¸èµ·{{zh}}ï¼",
              explainKoPrefix: "â€˜{{ko}}â€™ì—ê²Œ ë¯¸ì•ˆí•œ ë§ˆìŒì„ ì „í•´ìš”.",
              cards: [
                { zh: "ç¥",    pinyin: "shÃ©n",      ko: "í•˜ë‚˜ë‹˜",       meaning: "í•˜ë‚˜ë‹˜" },
                { zh: "è€¶ç¨£",  pinyin: "YÄ“sÅ«",      ko: "ì˜ˆìˆ˜ë‹˜",       meaning: "ì˜ˆìˆ˜ë‹˜" },
                { zh: "ä½ ",    pinyin: "nÇ",        ko: "ë„ˆ",           meaning: "ë„ˆ" },
                { zh: "ä»–",    pinyin: "tÄ",        ko: "ê·¸",           meaning: "ê·¸" },
                { zh: "å¥¹",    pinyin: "tÄ",        ko: "ê·¸ë…€",         meaning: "ê·¸ë…€" },
                { zh: "æˆ‘ä»¬",  pinyin: "wÇ’men",     ko: "ìš°ë¦¬",         meaning: "ìš°ë¦¬" },
                { zh: "ä½ ä»¬",  pinyin: "nÇmen",     ko: "ë„ˆí¬",         meaning: "ë„ˆí¬" },
                { zh: "ä»–ä»¬",  pinyin: "tÄmen",     ko: "ê·¸ë“¤",         meaning: "ê·¸ë“¤" },
                { zh: "å¦ˆå¦ˆ",  pinyin: "mÄma",      ko: "ì—„ë§ˆ",         meaning: "ì—„ë§ˆ" },
                { zh: "çˆ¸çˆ¸",  pinyin: "bÃ ba",      ko: "ì•„ë¹ ",         meaning: "ì•„ë¹ " },
                { zh: "å“¥å“¥",  pinyin: "gÄ“ge",      ko: "í˜•",           meaning: "í˜•" },
                { zh: "å§å§",  pinyin: "jiÄ›jie",    ko: "ëˆ„ë‚˜/ì–¸ë‹ˆ",    meaning: "ëˆ„ë‚˜/ì–¸ë‹ˆ" },
                { zh: "å¼Ÿå¼Ÿ",  pinyin: "dÃ¬di",      ko: "ë‚¨ë™ìƒ",       meaning: "ë‚¨ë™ìƒ" },
                { zh: "å¦¹å¦¹",  pinyin: "mÃ¨imei",    ko: "ì—¬ë™ìƒ",       meaning: "ì—¬ë™ìƒ" }
              ]
            }
          ],
          verses: [
            {
              ref: "ìš”í•œì¼ì„œ 1:9",
              textKo: "ë§Œì¼ ìš°ë¦¬ê°€ ìš°ë¦¬ ì£„ë¥¼ ìë°±í•˜ë©´ ê·¸ëŠ” ë¯¸ì˜ì‹œê³  ì˜ë¡œìš°ì‚¬ ìš°ë¦¬ ì£„ë¥¼ ì‚¬í•˜ì‹œë©° ìš°ë¦¬ë¥¼ ëª¨ë“  ë¶ˆì˜ì—ì„œ ê¹¨ë—í•˜ê²Œ í•˜ì‹¤ ê²ƒì´ìš”."
            }
          ]
        },
        {
          id: "2-7",
          tabLabel: "7",
          label: "2-7 ì°¬ì–‘ ë³µìŠµ",
          description:
            "2ê³¼ì˜ ì„¸ ë¬¸ì¥ì„ ë‹¤ì‹œ ê³ ë°±í•˜ê³ , ë‹¨ì–´Â·ëœ» ë§ì¶”ê¸° í€´ì¦ˆë¡œ ë³µìŠµí•´ìš”.",
          modes: ["study", "quiz", "flash", "verse", "song"],
          sentences: [
            {
              id: "2-7-1",
              zh: "æˆ‘è¦æ­Œé¢‚æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o gÄ“sÃ²ng wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì°¬ì–‘í•  ê±°ì˜ˆìš”."
            },
            {
              id: "2-7-2",
              zh: "æˆ‘è¦çˆ±ä½ æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o Ã i nÇ wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‹¹ì‹ , ë‚˜ì˜ í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•  ê±°ì˜ˆìš”."
            },
            {
              id: "2-7-3",
              zh: "æˆ‘è¦æ„Ÿè°¢æˆ‘ç¥ã€‚",
              pinyin: "wÇ’ yÃ o gÇnxiÃ¨ wÇ’ shÃ©n",
              ko: "ë‚˜ëŠ” ë‚˜ì˜ í•˜ë‚˜ë‹˜ê»˜ ê°ì‚¬í•  ê±°ì˜ˆìš”."
            }
          ],
          verses: [
            {
              ref: "ì‹œí¸ 150:6",
              textKo: "í˜¸í¡ì´ ìˆëŠ” ìë§ˆë‹¤ ì—¬í˜¸ì™€ë¥¼ ì°¬ì–‘í• ì§€ì–´ë‹¤ í• ë ë£¨ì•¼!"
            },
            {
              ref: "ì‹ ëª…ê¸° 6:5",
              textKo: "ë„ˆëŠ” ë§ˆìŒì„ ë‹¤í•˜ê³  ëœ»ì„ ë‹¤í•˜ê³  í˜ì„ ë‹¤í•˜ì—¬ ë„¤ í•˜ë‚˜ë‹˜ ì—¬í˜¸ì™€ë¥¼ ì‚¬ë‘í•˜ë¼."
            },
            {
              ref: "ì‹œí¸ 136:1",
              textKo: "ì—¬í˜¸ì™€ê»˜ ê°ì‚¬í•˜ë¼ ê·¸ëŠ” ì„ í•˜ì‹œë©° ê·¸ ì¸ìí•˜ì‹¬ì´ ì˜ì›í•¨ì´ë¡œë‹¤."
            }
          ],
          matchGame: {
            leftTitle: "ì¤‘êµ­ì–´ ë‹¨ì–´",
            rightTitle: "ëœ»",
            pairs: [
              { key: "æ­Œé¢‚", leftLabel: "â‘  æ­Œé¢‚ gÄ“sÃ²ng", rightLabel: "ì°¬ì–‘í•˜ë‹¤" },
              { key: "çˆ±", leftLabel: "â‘¡ çˆ± Ã i", rightLabel: "ì‚¬ë‘í•˜ë‹¤" },
              { key: "æ„Ÿè°¢", leftLabel: "â‘¢ æ„Ÿè°¢ gÇnxiÃ¨", rightLabel: "ê°ì‚¬í•˜ë‹¤" },
              { key: "è°¢è°¢", leftLabel: "â‘£ è°¢è°¢ xiÃ¨xie", rightLabel: "ê³ ë§ˆì›Œ / ê°ì‚¬í•©ë‹ˆë‹¤" },
              { key: "å¯¹ä¸èµ·", leftLabel: "â‘¤ å¯¹ä¸èµ· duÃ¬buqÇ", rightLabel: "ë¯¸ì•ˆí•´ìš” / ì£„ì†¡í•©ë‹ˆë‹¤" }
            ]
          }
        }
      ]
    };

    /* ========= í”Œë˜ì‹œ ì¹´ë“œ ê³µí†µ ë‹¨ì–´ (2ê³¼) ========= */
    const flashVocab = [
      { hanzi: "æˆ‘", pinyin: "wÇ’", meaning: "ë‚˜" },
      { hanzi: "è¦", pinyin: "yÃ o", meaning: "~í•  ê²ƒì´ë‹¤" },
      { hanzi: "æ­Œé¢‚", pinyin: "gÄ“sÃ²ng", meaning: "ì°¬ì–‘í•˜ë‹¤" },
      { hanzi: "çˆ±", pinyin: "Ã i", meaning: "ì‚¬ë‘í•˜ë‹¤" },
      { hanzi: "æ„Ÿè°¢", pinyin: "gÇnxiÃ¨", meaning: "ê°ì‚¬í•˜ë‹¤" },
      { hanzi: "ç¥", pinyin: "shÃ©n", meaning: "í•˜ë‚˜ë‹˜" },
      { hanzi: "è€¶ç¨£", pinyin: "YÄ“sÅ«", meaning: "ì˜ˆìˆ˜ë‹˜" },
      { hanzi: "è°¢è°¢", pinyin: "xiÃ¨xie", meaning: "ê³ ë§ˆì›Œ / ê°ì‚¬í•©ë‹ˆë‹¤" },
      { hanzi: "å¯¹ä¸èµ·", pinyin: "duÃ¬buqÇ", meaning: "ë¯¸ì•ˆí•´ìš” / ì£„ì†¡í•©ë‹ˆë‹¤" },
      { hanzi: "çˆ¸çˆ¸", pinyin: "bÃ ba", meaning: "ì•„ë¹ " },
      { hanzi: "å¦ˆå¦ˆ", pinyin: "mÄma", meaning: "ì—„ë§ˆ" },
      { hanzi: "æˆ‘ä»¬", pinyin: "wÇ’men", meaning: "ìš°ë¦¬" }
    ];

    /* ========= ê³µí†µ ëª¨ë“œ ì •ì˜ ========= */
    const defaultModes = [
      { id: "study", label: "í•™ìŠµ ë¬¸ì¥" },
      { id: "builder", label: "ë¬¸ì¥ ë§Œë“¤ê¸°" },
      { id: "quiz", label: "í€´ì¦ˆ / ê²Œì„" },
      { id: "flash", label: "í”Œë˜ì‹œ ì¹´ë“œ" },
      { id: "verse", label: "ë§ì”€ ì¹´ë“œ" },
      { id: "song", label: "ì°¬ì–‘ ë³´ê¸°" }
    ];

    let currentStepId = lesson.steps[0].id;
    let currentModeId = lesson.steps[0].modes[0];

    function clear(el) {
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    function getCurrentStep() {
      return lesson.steps.find(s => s.id === currentStepId);
    }

    function speakChineseOnce(text) {
      if (!("speechSynthesis" in window)) {
        alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
        return;
      }
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-CN";
      u.rate = 0.65;
      speechSynthesis.speak(u);
    }

    function speakChineseRepeated(text) {
      if (!("speechSynthesis" in window)) {
        alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
        return;
      }
      speechSynthesis.cancel();
      let count = 0;
      function play() {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "zh-CN";
        u.rate = 0.65;
        u.onend = () => {
          count++;
          if (count < 5) setTimeout(play, 300);
        };
        speechSynthesis.speak(u);
      }
      play();
    }

    /* ========= í•™ìŠµ ë¬¸ì¥ + ê·¸ ì•„ë˜ ì „ìš© í”Œë˜ì‹œ ì¹´ë“œ ========= */
    function renderStudy(step, c) {
      const intro = document.createElement("div");
      intro.className = "card";
      intro.innerHTML = `
        <div class="section-label">${step.label} Â· í•™ìŠµ ë¬¸ì¥</div>
        <div class="ko">${step.description || ""}</div>
      `;
      c.appendChild(intro);

      if (!step.sentences || !step.sentences.length) return;

      step.sentences.forEach((s, idx) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="section-label">í•™ìŠµ ë¬¸ì¥ ${idx + 1}</div>
          <div class="zh">${s.zh}</div>
          <div class="pinyin">${s.pinyin}</div>
          <div class="ko">${s.ko}</div>
          <div class="btn-row">
            <button id="once-${s.id}">í•œë²ˆ ë“£ê¸° â–¶</button>
            <button class="secondary" id="five-${s.id}">ë‹¤ì„¯ ë²ˆ ë“£ê¸° â–¶â–¶</button>
          </div>
          <div class="hint">
            ë¬¸ì¥ì„ ë“¤ìœ¼ë©° ì…ìœ¼ë¡œ 5ë²ˆ ë”°ë¼ ë§í•´ ë³´ì„¸ìš”.
          </div>
        `;
        c.appendChild(card);

        document.getElementById(`once-${s.id}`).onclick = () => speakChineseOnce(s.zh);
        document.getElementById(`five-${s.id}`).onclick = () => speakChineseRepeated(s.zh);
      });

      /* --- ì´ ê³¼(í•´ë‹¹ íƒ­)ì—ì„œ ì“°ì¸ ë‹¨ì–´ë¡œ í”Œë˜ì‹œ ì¹´ë“œ ì¶”ê°€ --- */
      const texts = [];
      step.sentences.forEach(s => texts.push(s.zh));
      if (step.builderBlocks) {
        step.builderBlocks.forEach(b => {
          (b.cards || []).forEach(card => texts.push(card.zh));
        });
      }
      if (step.matchGame && step.matchGame.pairs) {
        step.matchGame.pairs.forEach(p => texts.push(p.key));
      }

      let stepVocab = [];
      if (texts.length) {
        stepVocab = flashVocab.filter(v =>
          texts.some(t => (t || "").includes(v.hanzi))
        );
      }
      if (stepVocab.length === 0) stepVocab = flashVocab;

      const flashCard = document.createElement("div");
      flashCard.className = "card study-flash-card";
      flashCard.innerHTML = `
        <div class="section-label">${step.label} Â· ì´ ê³¼ ë‹¨ì–´ í”Œë˜ì‹œ ì¹´ë“œ</div>
        <div class="ko">
          ë°©ê¸ˆ ë°°ìš´ ë¬¸ì¥ì— ë‚˜ì˜¤ëŠ” ë‹¨ì–´ë“¤ì„ ì¹´ë“œë¡œ ë³µìŠµí•´ìš”.
        </div>
        <div class="flash-wrapper">
          <button class="arrow-btn" id="study-flash-prev">â—€</button>
          <div class="flashcard" id="study-flash-card">
            <div class="flash-counter" id="study-flash-counter"></div>
            <div class="flash-face" id="study-flash-face"></div>
          </div>
          <button class="arrow-btn" id="study-flash-next">â–¶</button>
        </div>
        <div class="idx-text" id="study-flash-idx"></div>
        <div class="btn-row">
          <button id="study-flash-speak">ë‹¤ì‹œ ë“£ê¸° â–¶</button>
        </div>
        <div class="hint">
          ì¹´ë“œë¥¼ ëˆŒëŸ¬ ì•/ë’·ë©´ì„ ë°”ê¾¸ê³ , í•œìë¥¼ ë³´ê³  ëœ»ì„ ë§ì¶° ë³´ì„¸ìš”.
        </div>
      `;
      c.appendChild(flashCard);

      let idx = 0;
      let front = true;

      function drawStudyFlash() {
        const v = stepVocab[idx];
        const face = document.getElementById("study-flash-face");
        const counterEl = document.getElementById("study-flash-counter");
        const cardEl = document.getElementById("study-flash-card");

        counterEl.textContent = `${idx + 1} / ${stepVocab.length}`;
        document.getElementById("study-flash-idx").innerText =
          `${idx + 1} / ${stepVocab.length}`;

        if (front) {
          cardEl.classList.remove("back");
          face.innerHTML = `<div class="flash-front">${v.hanzi}</div>`;
          speakChineseOnce(v.hanzi);
        } else {
          cardEl.classList.add("back");
          face.innerHTML = `
            <div class="flash-back-main">${v.meaning}</div>
            <div class="flash-back-sub">${v.hanzi} Â· ${v.pinyin}</div>
          `;
        }
      }

      document.getElementById("study-flash-card").onclick = () => {
        front = !front;
        drawStudyFlash();
      };
      document.getElementById("study-flash-prev").onclick = () => {
        idx = (idx - 1 + stepVocab.length) % stepVocab.length;
        front = true;
        drawStudyFlash();
      };
      document.getElementById("study-flash-next").onclick = () => {
        idx = (idx + 1) % stepVocab.length;
        front = true;
        drawStudyFlash();
      };
      document.getElementById("study-flash-speak").onclick = () => {
        const v = stepVocab[idx];
        speakChineseOnce(v.hanzi);
      };

      drawStudyFlash();
    }

    function renderSong(step, c) {
      const card = document.createElement("div");
      card.className = "card";
      const url =
        step.songUrlOverride || step.songUrl || lesson.songUrl || null;

      const videoHtml = url
        ? `
        <div class="video-wrapper">
          <iframe
            src="${url}"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen>
          </iframe>
        </div>`
        : "<div class='hint'>ì´ ë‹¨ê³„ì—ëŠ” ë“±ë¡ëœ ì°¬ì–‘ ì˜ìƒì´ ì—†ì–´ìš”.</div>";

      card.innerHTML = `
        <div class="section-label">${step.label} Â· ì°¬ì–‘ ë³´ê¸°</div>
        <h2>ì¤‘êµ­ì–´ ì°¬ì–‘ - æˆ‘è¦æ­Œé¢‚æˆ‘ç¥</h2>
        ${videoHtml}
        <div class="hint">ì˜ìƒì„ ë³´ë©° ê°€ì‚¬ë¥¼ ë”°ë¼ ë¶ˆëŸ¬ ë³´ì„¸ìš”.</div>
      `;
      c.appendChild(card);

      if (step.sentences && step.sentences.length) {
        const lyric = document.createElement("div");
        lyric.className = "card";
        lyric.innerHTML = `<div class="section-label">í•µì‹¬ ê°€ì‚¬ & í‘œí˜„</div>`;
        step.sentences.forEach(s => {
          const block = document.createElement("div");
          block.style.marginBottom = "16px";
          block.innerHTML = `
            <div class="zh">${s.zh}</div>
            <div class="pinyin">${s.pinyin}</div>
            <div class="ko">${s.ko}</div>
            <div class="btn-row">
              <button>í•œë²ˆ ë“£ê¸° â–¶</button>
              <button class="secondary">ë‹¤ì„¯ ë²ˆ ë“£ê¸° â–¶â–¶</button>
            </div>
          `;
          const [btnOnce, btnFive] = block.querySelectorAll("button");
          btnOnce.onclick = () => speakChineseOnce(s.zh);
          btnFive.onclick = () => speakChineseRepeated(s.zh);
          lyric.appendChild(block);
        });
        c.appendChild(lyric);
      }
    }

    function renderVerse(step, c) {
      const versesFromStep = step.verses || [];
      const intro = document.createElement("div");
      intro.className = "card";
      intro.innerHTML = `
        <div class="section-label">${step.label} Â· ë§ì”€ ì¹´ë“œ</div>
        <div class="ko">
          ì°¬ì–‘ ê°€ì‚¬ì™€ ì—°ê²°ëœ ì„±ê²½ ë§ì”€ì„ í•œ êµ¬ì ˆì”© ì½ê³  ë¬µìƒí•´ ë³´ì•„ìš”.
        </div>
      `;
      c.appendChild(intro);

      if (!versesFromStep.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `
          <div class="hint">ì´ ë‹¨ê³„ì—ëŠ” ì—°ê²°ëœ ë§ì”€ì´ ì—†ì–´ìš”.</div>
        `;
        c.appendChild(empty);
        return;
      }

      versesFromStep.forEach(v => {
        const card = document.createElement("div");
        card.className = "card verse-card";
        card.innerHTML = `
          <div class="verse-ref">ğŸ“– ${v.ref}</div>
          <div class="verse-text">${v.textKo}</div>
        `;
        c.appendChild(card);
      });
    }

    function renderBuilder(step, c) {
      const blocks = step.builderBlocks || [];
      if (!blocks.length) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="section-label">${step.label} Â· ë¬¸ì¥ ë§Œë“¤ê¸°</div>
          <div class="hint">ì´ ë‹¨ê³„ì—ëŠ” ë¬¸ì¥ ë§Œë“¤ê¸° í™œë™ì´ ì—†ì–´ìš”.</div>
        `;
        c.appendChild(card);
        return;
      }

      blocks.forEach((block, blockIdx) => {
        const card = document.createElement("div");
        card.className = "card";
        const containerId = `builder-${step.id}-${block.id}-${blockIdx}`;
        const zhTmplId = `${containerId}-tmpl-zh`;
        const koTmplId = `${containerId}-tmpl-ko`;
        const zhAnsId = `${containerId}-ans-zh`;
        const pyAnsId = `${containerId}-ans-py`;
        const koAnsId = `${containerId}-ans-ko`;
        const statusId = `${containerId}-status`;
        const miniWrapId = `${containerId}-mini-wrap`;

        card.innerHTML = `
          <div class="section-label">${step.label} Â· ${block.title || "ë¬¸ì¥ ë§Œë“¤ê¸°"}</div>
          <div style="background:#e0f2fe; padding:12px 16px; border-radius:12px;">
            <div id="${zhTmplId}" class="zh" style="font-size:40px; margin-bottom:6px;">
              ${block.templateZhDisplay.replace("{{zh}}", "ï¼ˆ      ï¼‰")}
            </div>
            <div id="${koTmplId}" class="ko" style="margin:0;">
              ${block.templateKoDisplay.replace("{{ko}}", "(      )")}
            </div>
          </div>
          <div class="hint" style="margin-top:6px;">
            ì•„ë˜ <b>ë‹¨ì–´ ì¹´ë“œ</b>ë¥¼ ëˆŒëŸ¬ ê´„í˜¸ ì•ˆì— ë“¤ì–´ê°ˆ ë§ì„ ê³¨ë¼ ë³´ì„¸ìš”.
            ì„ íƒí•˜ë©´ ìœ„ ë¬¸ì¥ì´ ë°”ë€Œê³  ì¤‘êµ­ì–´ë¡œ í•œ ë²ˆ ì½ì–´ì¤˜ìš”.
          </div>
          <div class="mini-card-container" id="${miniWrapId}"></div>
          <div class="zh" id="${zhAnsId}" style="display:none; margin-top:16px;"></div>
          <div class="pinyin" id="${pyAnsId}" style="display:none;"></div>
          <div class="ko" id="${koAnsId}" style="display:none; font-size:20px;"></div>
          <div class="hint" id="${statusId}"></div>
        `;
        c.appendChild(card);

        const miniWrap = document.getElementById(miniWrapId);
        const zhTmplEl = document.getElementById(zhTmplId);
        const koTmplEl = document.getElementById(koTmplId);
        const zhAnsEl = document.getElementById(zhAnsId);
        const pyAnsEl = document.getElementById(pyAnsId);
        const koAnsEl = document.getElementById(koAnsId);
        const statusEl = document.getElementById(statusId);

        (block.cards || []).forEach(info => {
          const mc = document.createElement("div");
          mc.className = "mini-card";
          mc.innerHTML = `
            <div class="mini-card-title">${info.ko}</div>
            <div class="mini-card-zh">${info.zh}</div>
            <div class="mini-card-sub">${info.pinyin} Â· ${info.meaning}</div>
          `;
          mc.onclick = () => {
            const zhDisp = block.templateZhDisplay.replace("{{zh}}", info.zh);
            const koDisp = block.templateKoDisplay.replace("{{ko}}", info.ko);
            const zhSpeak = block.templateZhSpeak.replace("{{zh}}", info.zh);

            zhTmplEl.innerHTML = zhDisp;
            koTmplEl.innerHTML = koDisp;

            zhAnsEl.style.display = "block";
            pyAnsEl.style.display = "block";
            koAnsEl.style.display = "block";

            zhAnsEl.textContent = zhSpeak;
            pyAnsEl.textContent = info.pinyin;

            const explainKo =
              (block.explainKoPrefix || "")
                .replace("{{ko}}", info.ko) ||
              `"${info.ko}"ë¥¼ ë„£ì–´ì„œ ë§Œë“  ë¬¸ì¥ì´ì—ìš”.`;
            koAnsEl.textContent = explainKo;

            statusEl.textContent = "ì™„ì„±ëœ ì¤‘êµ­ì–´ ë¬¸ì¥ì„ í•œ ë²ˆ ì½ì–´ ì¤„ê²Œìš”. ë”°ë¼ ë§í•´ ë³´ì„¸ìš”!";
            speakChineseOnce(zhSpeak);
          };
          miniWrap.appendChild(mc);
        });
      });
    }

    function renderQuiz(step, c) {
      if (step.matchGame) {
        const m = step.matchGame;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="section-label">${step.label} Â· ë‹¨ì–´ & ëœ» ë§ì¶”ê¸° ê²Œì„</div>
          <div class="ko">
            ì™¼ìª½ ì¤‘êµ­ì–´ ë‹¨ì–´ì™€ ì˜¤ë¥¸ìª½ ëœ»ì„ <b>ìˆœì„œëŒ€ë¡œ ëˆŒëŸ¬ì„œ</b> ì§ì„ ë§ì¶° ë³´ì„¸ìš”.
          </div>
          <div class="match-layout">
            <div class="match-col">
              <div class="section-label">${m.leftTitle || "ì¤‘êµ­ì–´ ë‹¨ì–´"}</div>
              <div id="match-left"></div>
            </div>
            <div class="match-col">
              <div class="section-label">${m.rightTitle || "ëœ»"}</div>
              <div id="match-right"></div>
            </div>
          </div>
          <div class="hint" id="match-status" style="margin-top:12px;"></div>
        `;
        c.appendChild(card);

        const leftEl = card.querySelector("#match-left");
        const rightEl = card.querySelector("#match-right");
        const statusEl = card.querySelector("#match-status");

        const pairs = m.pairs || [];

        const leftItems = pairs.map(p => ({
          key: p.key,
          label: p.leftLabel || p.key
        }));

        let rightItems = pairs.map(p => ({
          key: p.key,
          label: p.rightLabel || ""
        }));

        for (let i = rightItems.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [rightItems[i], rightItems[j]] = [rightItems[j], rightItems[i]];
        }

        leftItems.forEach(item => {
          const btn = document.createElement("button");
          btn.className = "match-btn";
          btn.dataset.key = item.key;
          btn.textContent = item.label;
          leftEl.appendChild(btn);
        });

        rightItems.forEach(item => {
          const btn = document.createElement("button");
          btn.className = "match-btn";
          btn.dataset.key = item.key;
          btn.textContent = item.label;
          rightEl.appendChild(btn);
        });

        let selectedLeft = null;
        let solvedCount = 0;
        const total = pairs.length;

        function clearSelectedLeft() {
          leftEl.querySelectorAll(".match-btn").forEach(b => b.classList.remove("selected"));
        }

        leftEl.querySelectorAll(".match-btn").forEach(btn => {
          btn.onclick = () => {
            if (btn.classList.contains("correct")) return;
            clearSelectedLeft();
            btn.classList.add("selected");
            selectedLeft = btn.dataset.key;
            statusEl.textContent = "ì´ì œ ì˜¤ë¥¸ìª½ì—ì„œ ì§ì´ ë˜ëŠ” ëœ»ì„ ê³¨ë¼ ë³´ì„¸ìš”.";
          };
        });

        rightEl.querySelectorAll(".match-btn").forEach(btn => {
          btn.onclick = () => {
            if (btn.classList.contains("correct")) return;
            if (!selectedLeft) {
              statusEl.textContent = "ë¨¼ì € ì™¼ìª½ì—ì„œ ë‹¨ì–´ë¥¼ í•˜ë‚˜ ê³ ë¥´ì„¸ìš”.";
              return;
            }
            const rightKey = btn.dataset.key;
            const leftBtn = leftEl.querySelector(`.match-btn[data-key="${selectedLeft}"]`);
            if (!leftBtn) return;

            if (rightKey === selectedLeft) {
              leftBtn.classList.remove("selected");
              leftBtn.classList.add("correct");
              btn.classList.add("correct");
              solvedCount++;
              statusEl.textContent = "ì •ë‹µì´ì—ìš”! ì˜í–ˆì–´ìš” ğŸ‘";
              speakChineseOnce(selectedLeft);
              selectedLeft = null;
              if (solvedCount === total) {
                statusEl.textContent = "ëª¨ë“  ë‹¨ì–´ë¥¼ ë‹¤ ë§ì·„ì–´ìš”! ì •ë§ ì˜í–ˆì–´ìš” ğŸ‰";
              }
            } else {
              btn.classList.add("wrong");
              statusEl.textContent = "ì¡°ê¸ˆ ì•„ì‰¬ì›Œìš”. ë‹¤ì‹œ í•œ ë²ˆ ìƒê°í•´ ë³¼ê¹Œ?";
              setTimeout(() => {
                btn.classList.remove("wrong");
                clearSelectedLeft();
                selectedLeft = null;
              }, 600);
            }
          };
        });

        return;
      }

      const placeholder = document.createElement("div");
      placeholder.className = "card";
      placeholder.innerHTML = `
        <div class="section-label">${step.label} Â· í€´ì¦ˆ / ê²Œì„</div>
        <div class="hint">ì´ ë‹¨ê³„ì—ëŠ” ì•„ì§ ë³„ë„ í€´ì¦ˆê°€ ì—†ì–´ìš”.</div>
      `;
      c.appendChild(placeholder);
    }

    /* ì „ì²´ í”Œë˜ì‹œ ëª¨ë“œ (íƒ­ë§ˆë‹¤ ê³µí†µ ë‹¨ì–´) */
    function renderFlash(step, c) {
      const intro = document.createElement("div");
      intro.className = "card";
      intro.innerHTML = `
        <div class="section-label">${step.label} Â· í”Œë˜ì‹œ ì¹´ë“œ</div>
        <div class="ko">
          2ê³¼ì—ì„œ ìì£¼ ë‚˜ì˜¤ëŠ” ì¤‘êµ­ì–´ ë‹¨ì–´ë“¤ì„ ì•ë©´Â·ë’·ë©´ìœ¼ë¡œ ë³´ë©° ë“£ê³  ì™¸ì›Œ ë³´ì„¸ìš”.
        </div>
      `;
      c.appendChild(intro);

      let stepVocab = [];
      const texts = [];

      if (step.sentences) {
        step.sentences.forEach(s => texts.push(s.zh));
      }
      if (step.builderBlocks) {
        step.builderBlocks.forEach(b => {
          (b.cards || []).forEach(card => texts.push(card.zh));
        });
      }
      if (step.matchGame && step.matchGame.pairs) {
        step.matchGame.pairs.forEach(p => texts.push(p.key));
      }

      if (texts.length) {
        stepVocab = flashVocab.filter(v =>
          texts.some(t => (t || "").includes(v.hanzi))
        );
      }
      if (stepVocab.length === 0) stepVocab = flashVocab;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="flash-wrapper">
          <button class="arrow-btn" id="flash-prev">â—€</button>
          <div class="flashcard" id="flash-card">
            <div class="flash-counter" id="flash-counter"></div>
            <div class="flash-face" id="flash-face"></div>
          </div>
          <button class="arrow-btn" id="flash-next">â–¶</button>
        </div>
        <div class="idx-text" id="flash-idx"></div>
        <div class="btn-row">
          <button id="flash-speak">ë‹¤ì‹œ ë“£ê¸° â–¶</button>
        </div>
        <div class="hint">ì¹´ë“œë¥¼ ëˆŒëŸ¬ ì•/ë’·ë©´ì„ ë°”ê¾¸ê³ , ë°œìŒì„ ë“¤ìœ¼ë©° ì—¬ëŸ¬ ë²ˆ ë”°ë¼ ë§í•´ ë³´ì„¸ìš”.</div>
      `;
      c.appendChild(card);

      let idx = 0;
      let front = true;

      function draw() {
        const v = stepVocab[idx];
        const face = document.getElementById("flash-face");
        const counterEl = document.getElementById("flash-counter");
        const cardEl = document.getElementById("flash-card");

        counterEl.textContent = `${idx + 1} / ${stepVocab.length}`;
        document.getElementById("flash-idx").innerText = `${idx + 1} / ${stepVocab.length}`;

        if (front) {
          cardEl.classList.remove("back");
          face.innerHTML = `<div class="flash-front">${v.hanzi}</div>`;
          speakChineseOnce(v.hanzi);
        } else {
          cardEl.classList.add("back");
          face.innerHTML = `
            <div class="flash-back-main">${v.meaning}</div>
            <div class="flash-back-sub">${v.hanzi} Â· ${v.pinyin}</div>
          `;
        }
      }

      document.getElementById("flash-card").onclick = () => {
        front = !front;
        draw();
      };
      document.getElementById("flash-prev").onclick = () => {
        idx = (idx - 1 + stepVocab.length) % stepVocab.length;
        front = true;
        draw();
      };
      document.getElementById("flash-next").onclick = () => {
        idx = (idx + 1) % stepVocab.length;
        front = true;
        draw();
      };
      document.getElementById("flash-speak").onclick = () => {
        const v = stepVocab[idx];
        speakChineseOnce(v.hanzi);
      };

      draw();
    }

    const titleEl = document.getElementById("lesson-title");
    const subtitleEl = document.getElementById("lesson-subtitle");
    const stepTabsEl = document.getElementById("step-tabs");
    const modeTabsEl = document.getElementById("mode-tabs");
    const contentEl = document.getElementById("content");

    titleEl.textContent = lesson.title;
    subtitleEl.textContent = lesson.subtitle;

    function renderStepTabs() {
      clear(stepTabsEl);
      lesson.steps.forEach((step, idx) => {
        const b = document.createElement("button");
        b.className = "step-tab";
        if (step.id === currentStepId) b.classList.add("active");
        b.textContent = step.tabLabel || String(idx + 1);
        b.title = step.label;
        b.onclick = () => {
          currentStepId = step.id;
          const stepModes = step.modes && step.modes.length ? step.modes : ["study"];
          if (!stepModes.includes(currentModeId)) {
            currentModeId = stepModes[0];
          }
          renderStepTabs();
          renderModeTabs();
          renderContent();
        };
        stepTabsEl.appendChild(b);
      });
    }

    function renderModeTabs() {
      clear(modeTabsEl);
      const step = getCurrentStep();
      if (!step) return;
      const enabled = step.modes && step.modes.length ? step.modes : ["study"];

      defaultModes.forEach(m => {
        if (!enabled.includes(m.id)) return;
        const b = document.createElement("button");
        b.className = "mode-tab";
        if (m.id === currentModeId) b.classList.add("active");
        b.textContent = m.label;
        b.onclick = () => {
          currentModeId = m.id;
          renderModeTabs();
          renderContent();
        };
        modeTabsEl.appendChild(b);
      });
    }

    function renderContent() {
      clear(contentEl);
      const step = getCurrentStep();
      if (!step) return;

      const enabled = step.modes && step.modes.length ? step.modes : ["study"];
      if (!enabled.includes(currentModeId)) {
        currentModeId = enabled[0];
        renderModeTabs();
      }

      if (currentModeId === "study") renderStudy(step, contentEl);
      else if (currentModeId === "builder") renderBuilder(step, contentEl);
      else if (currentModeId === "quiz") renderQuiz(step, contentEl);
      else if (currentModeId === "flash") renderFlash(step, contentEl);
      else if (currentModeId === "verse") renderVerse(step, contentEl);
      else if (currentModeId === "song") renderSong(step, contentEl);
    }

    renderStepTabs();
    renderModeTabs();
    renderContent();
  </script>
</body>
</html>
